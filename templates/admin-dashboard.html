<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SLRD System (Complete Upgrade)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        /* ============================================
           PHASE 1-3: SECURITY + RBAC + UI DESIGN SYSTEM
           ============================================ */

        :root {
            /* Professional Color Palette */
            --primary: #667eea;
            --secondary: #764ba2;
            --bg: #ffffff;
            --bg-secondary: #f7fafc;
            --text: #2d3748;
            --text-secondary: #718096;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --info: #4299e1;
            --hover: #edf2f7;
        }

        .dark-mode {
            --bg: #1a202c;
            --bg-secondary: #2d3748;
            --text: #f7fafc;
            --text-secondary: #a0aec0;
            --border: #4a5568;
            --shadow: rgba(0, 0, 0, 0.3);
            --hover: #4a5568;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: var(--text);
        }

        .dark-mode body {
            background: var(--bg-secondary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header Enhancements with Role Badge */
        .header {
            background: var(--bg);
            padding: 24px 30px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            box-shadow: 0 12px 40px var(--shadow);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .header h1 {
            color: var(--primary);
            font-size: 32px;
            font-weight: 800;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .company-logo {
            height: 50px;
            width: auto;
            max-width: 150px;
            object-fit: contain;
        }

        .admin-info {
            text-align: right;
        }

        .admin-name {
            color: var(--text);
            font-weight: 700;
            font-size: 15px;
        }

        .admin-role {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 4px;
        }

        /* Add role badge display for RBAC */
        .role-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-left: 8px;
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: var(--text);
        }

        .theme-toggle:hover {
            background: var(--hover);
            transform: scale(1.05);
        }

        .theme-toggle i {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: var(--danger);
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 13px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-card {
            background: var(--bg);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 12px 40px var(--shadow);
            text-align: center;
            transition: all 0.3s ease;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 16px 50px var(--shadow);
        }

        .action-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 18px;
        }

        .action-card p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--shadow);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px var(--shadow);
        }

        .stat-card h3 {
            font-size: 28px;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-card p {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .stat-card.primary {
            border-left: 4px solid var(--primary);
        }

        .stat-card.success {
            border-left: 4px solid var(--success);
        }

        .stat-card.warning {
            border-left: 4px solid var(--warning);
        }

        .stat-card.danger {
            border-left: 4px solid var(--danger);
        }

        .stat-card.info {
            border-left: 4px solid var(--info);
        }

        .tabs-nav {
            display: flex;
            gap: 0;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Enhance table styling with better contrast and readability */
        .table {
            background: var(--bg);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border);
        }

        .table th {
            color: var(--text);
            font-weight: 700;
            padding: 15px;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .table th:hover {
            background: var(--hover);
        }

        /* Add sort indicator styles for Phase 4 */
        .sort-indicator {
            font-size: 12px;
            margin-left: 5px;
            opacity: 0.5;
        }

        .table td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--bg);
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 500px;
            max-width: 95%;
            box-shadow: 0 10px 30px var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary);
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .close:hover {
            color: var(--text);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg);
            color: var(--text);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Add password strength indicator styles */
        .password-strength {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .password-strength.weak {
            background: rgba(245, 101, 101, 0.1);
            color: #f56565;
        }

        .password-strength.medium {
            background: rgba(237, 137, 54, 0.1);
            color: #ed8936;
        }

        .password-strength.strong {
            background: rgba(72, 187, 120, 0.1);
            color: #48bb78;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        /* Enhanced notification styles with multiple types */
        .notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow);
            z-index: 10001;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            word-wrap: break-word;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--danger);
            color: white;
        }

        .notification.info {
            background: var(--info);
            color: white;
        }

        .notification.warning {
            background: var(--warning);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Add Phase 4 search and filter styles */
        .search-filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input-group {
            flex: 1;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg);
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .search-input-group input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 14px;
        }

        .search-input-group input::placeholder {
            color: var(--text-secondary);
        }

        .search-input-group input:focus {
            outline: none;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            min-width: 150px;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination-controls select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--hover);
            border-color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Add permission denied message styles */
        .permission-denied {
            background: rgba(245, 101, 101, 0.1);
            border-left: 4px solid var(--danger);
            padding: 15px;
            border-radius: 6px;
            color: var(--danger);
            margin-bottom: 20px;
        }

        /* Add RBAC feature visibility controls */
        .rbac-hidden {
            display: none !important;
        }

        .projects-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .project-item {
            background: var(--bg);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.3s ease;
        }

        .project-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .project-item h4 {
            color: var(--text);
            margin-bottom: 8px;
        }

        .project-item p {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .progress {
            background: var(--border);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            transition: width 0.3s ease;
        }

        .deadlines-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .deadline-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .deadline-item:hover {
            background: var(--hover);
            transform: translateX(3px);
        }

        .deadline-item h5 {
            margin: 0 0 5px 0;
            color: var(--text);
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
            min-width: 250px;
            max-width: 400px;
        }

        .search-container input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: var(--bg);
            color: var(--text);
        }

        .search-container input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .project-detail-card {
            background: var(--bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }

        .project-detail-card h4 {
            color: var(--text);
            margin-bottom: 10px;
            margin-top: 0;
        }

        .project-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-item i {
            color: var(--primary);
            font-size: 18px;
        }

        .info-item span {
            color: var(--text-secondary);
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .project-info {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .dashboard-stats {
                grid-template-columns: 1fr 1fr;
            }

            .modal-content {
                width: 90%;
                margin: 20% auto;
            }

            .pagination-controls {
                justify-content: center;
            }

            .tabs-nav {
                flex-direction: column;
                border-bottom: none;
            }

            .tab-button {
                border-bottom: none;
                border-left: 3px solid transparent;
                padding: 12px 15px;
            }

            .tab-button.active {
                border-bottom: none;
                border-left-color: var(--primary);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <img src="/static/lg.png" alt="Company Logo" class="company-logo">
                <h1>Admin Dashboard</h1>
            </div>
            <div class="search-container">
                <i class="fas fa-search" style="color: #718096;"></i>
                <input type="text" id="adminSearchInput" placeholder="Search projects, tasks, team members..."
                    onkeyup="performAdminSearch(event)">
            </div>
            <div class="header-right">
                <!-- Add role badge display for RBAC -->
                <span id="roleDisplay" class="role-badge"></span>
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="admin-info">
                    <div class="admin-name" id="adminName">Abhijeet</div>
                    <div class="admin-role" id="adminRoleDisplay">Administrator</div>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Enhanced notification system for Phase 1-4 features -->
        <div id="successMessage" class="notification success"></div>
        <div id="errorMessage" class="notification error"></div>
        <div id="infoMessage" class="notification info"></div>

        <!-- Permission denied message for RBAC -->
        <div id="permissionDenied" class="permission-denied" style="display: none;">
            <i class="fas fa-lock"></i> You don't have permission to perform this action.
        </div>

        <div class="action-buttons">
            <div class="action-card">
                <h3><i class="fas fa-chart-line"></i> Dashboard Overview</h3>
                <p>View project statistics and task analytics</p>
                <button class="btn btn-primary" onclick="selectTab('overview-tab')">View Dashboard</button>
            </div>
            <div class="action-card" id="manageUserTypesCard">
                <h3><i class="fas fa-users-cog"></i> Manage User Types</h3>
                <p>Create and manage employee roles</p>
                <button class="btn btn-primary" onclick="selectTab('usertypes-tab')">Manage Types</button>
            </div>
            <div class="action-card" id="createEmployeeCard">
                <h3><i class="fas fa-user-plus"></i> Create Employee</h3>
                <p>Add new employees to the system</p>
                <button class="btn btn-primary" onclick="openUserModal()">Create Employee</button>
            </div>
            <div class="action-card">
                <h3><i class="fas fa-list-check"></i> View Employees</h3>
                <p>Manage all system employees</p>
                <button class="btn btn-primary" onclick="selectTab('users-tab')">View Employees</button>
            </div>
            <!-- Add audit logs card for Phase 2 RBAC -->
            <div class="action-card" id="auditLogsCard">
                <h3><i class="fas fa-history"></i> Audit Logs</h3>
                <p>View system activity and changes</p>
                <button class="btn btn-primary" onclick="selectTab('audit-tab')">View Logs</button>
            </div>
        </div>

        <div style="background: var(--bg); border-radius: 16px; box-shadow: 0 12px 40px var(--shadow); padding: 30px;">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="selectTab('overview-tab')">Dashboard Overview</button>
                <button class="tab-button" onclick="selectTab('usertypes-tab')" id="userTypesTab">User Types</button>
                <button class="tab-button" onclick="selectTab('users-tab')">Employees</button>
                <!-- Add audit logs tab for Phase 2 -->
                <button class="tab-button" onclick="selectTab('audit-tab')" id="auditTab">Audit Logs</button>
            </div>

            <div id="overview-tab" class="tab-content active">
                <div class="dashboard-stats">
                    <div class="stat-card primary" onclick="showDetailModal('active_projects')">
                        <div style="text-align: center; font-size: 24px; color: #667eea;"><i class="fas fa-folder"></i>
                        </div>
                        <h3 id="activeProjectsCount">0</h3>
                        <p>Active Projects</p>
                    </div>
                    <div class="stat-card success" onclick="showDetailModal('completed_tasks')">
                        <div style="text-align: center; font-size: 24px; color: #28a745;"><i
                                class="fas fa-check-circle"></i></div>
                        <h3 id="completedTasksCount">0</h3>
                        <p>Completed Tasks</p>
                    </div>
                    <div class="stat-card warning" onclick="showDetailModal('active_tasks')">
                        <div style="text-align: center; font-size: 24px; color: #ffc107;"><i class="fas fa-clock"></i>
                        </div>
                        <h3 id="activeTasksCount">0</h3>
                        <p>Active Tasks</p>
                    </div>
                    <div class="stat-card danger" onclick="showDetailModal('overdue_tasks')">
                        <div style="text-align: center; font-size: 24px; color: #dc3545;"><i
                                class="fas fa-exclamation-triangle"></i></div>
                        <h3 id="overdueTasksCount">0</h3>
                        <p>Overdue Tasks</p>
                    </div>
                    <div class="stat-card info" onclick="showDetailModal('pending_approvals')">
                        <div style="text-align: center; font-size: 24px; color: #17a2b8;"><i
                                class="fas fa-clipboard-check"></i></div>
                        <h3 id="pendingApprovalsCount">0</h3>
                        <p>Pending Approvals</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 25px;">
                    <div
                        style="background: var(--bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow);">
                        <h3 style="color: var(--primary); margin-bottom: 20px;"><i class="fas fa-folder"></i> Recent
                            Projects</h3>
                        <div class="projects-list" id="projectsList"></div>
                        <div id="noProjects" class="no-data">No projects available yet</div>
                    </div>

                    <div
                        style="background: var(--bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow);">
                        <h3 style="color: var(--primary); margin-bottom: 20px;"><i class="fas fa-calendar"></i> Upcoming
                            Deadlines</h3>
                        <div class="deadlines-list" id="deadlinesList"></div>
                        <div id="noDeadlines" class="no-data">No upcoming deadlines</div>
                    </div>
                </div>
            </div>

            <div id="usertypes-tab" class="tab-content">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="openUserTypeModal()" id="createUserTypeBtn">+ Create User
                        Type</button>
                </div>
                <!-- Add search and filter for Phase 4 -->
                <div class="search-filter-container">
                    <div class="search-input-group">
                        <i class="fas fa-search" style="color: var(--text-secondary);"></i>
                        <input type="text" id="userTypesSearch" placeholder="Search user types..."
                            onkeyup="filterUserTypes()">
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th onclick="sortUserTypes('id')">ID <span class="sort-indicator"></span></th>
                            <th onclick="sortUserTypes('role')">User Role <span class="sort-indicator"></span></th>
                            <th onclick="sortUserTypes('created')">Created At <span class="sort-indicator"></span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usertypesList"></tbody>
                </table>
                <div id="noUserTypes" class="no-data">No user types available</div>
                <!-- Add pagination and export for Phase 4 -->
                <div class="pagination-controls">
                    <select id="userTypesPerPage" onchange="changeUserTypesPerPage()">
                        <option value="10">10 per page</option>
                        <option value="25">25 per page</option>
                        <option value="50">50 per page</option>
                    </select>
                    <button class="pagination-btn" onclick="previousUserTypesPage()">&lt; Previous</button>
                    <span class="pagination-info" id="userTypesPaginationInfo">Page 1</span>
                    <button class="pagination-btn" onclick="nextUserTypesPage()">Next &gt;</button>
                    <button class="btn btn-secondary btn-sm" onclick="exportUserTypesCSV()"
                        id="exportUserTypesBtn"><i class="fas fa-download"></i> Export CSV</button>
                </div>
            </div>

            <div id="users-tab" class="tab-content">
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openUserModal()" id="createUserBtn">+ Create Employee</button>
                    <!-- Add export button for Phase 4 -->
                    <button class="btn btn-secondary" onclick="exportUsersCSV()" id="exportUsersBtn"><i
                            class="fas fa-download"></i> Export CSV</button>
                </div>
                <!-- Add search and filter for Phase 4 -->
                <div class="search-filter-container">
                    <div class="search-input-group">
                        <i class="fas fa-search" style="color: var(--text-secondary);"></i>
                        <input type="text" id="usersSearch" placeholder="Search by name, email, or role..."
                            onkeyup="filterUsers()">
                    </div>
                    <select class="filter-select" id="roleFilter" onchange="filterUsers()">
                        <option value="">All Roles</option>
                    </select>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th onclick="sortUsers('id')">ID <span class="sort-indicator"></span></th>
                            <th onclick="sortUsers('username')">Username <span class="sort-indicator"></span></th>
                            <th onclick="sortUsers('email')">Email <span class="sort-indicator"></span></th>
                            <th onclick="sortUsers('usertype')">User Type <span class="sort-indicator"></span></th>
                            <th onclick="sortUsers('created')">Created At <span class="sort-indicator"></span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersList"></tbody>
                </table>
                <div id="noUsers" class="no-data">No employees available</div>
                <!-- Add pagination controls for Phase 4 -->
                <div class="pagination-controls">
                    <select id="itemsPerPage" onchange="changeItemsPerPage()">
                        <option value="10">10 per page</option>
                        <option value="25">25 per page</option>
                        <option value="50">50 per page</option>
                    </select>
                    <button class="pagination-btn" onclick="previousPage()">&lt; Previous</button>
                    <span class="pagination-info" id="paginationInfo">Page 1 of 1</span>
                    <button class="pagination-btn" onclick="nextPage()">Next &gt;</button>
                </div>
            </div>

            <!-- Add audit logs tab for Phase 2 RBAC -->
            <div id="audit-tab" class="tab-content">
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="exportAuditLogsCSV()"><i
                            class="fas fa-download"></i> Export CSV</button>
                    <button class="btn btn-danger" onclick="clearAuditLogs()" id="clearAuditBtn">Clear Logs</button>
                </div>
                <div class="search-filter-container">
                    <div class="search-input-group">
                        <i class="fas fa-search" style="color: var(--text-secondary);"></i>
                        <input type="text" id="auditSearch" placeholder="Search logs..."
                            onkeyup="filterAuditLogs()">
                    </div>
                    <select class="filter-select" id="actionFilter" onchange="filterAuditLogs()">
                        <option value="">All Actions</option>
                        <option value="CREATE">Create</option>
                        <option value="UPDATE">Update</option>
                        <option value="DELETE">Delete</option>
                        <option value="EXPORT">Export</option>
                        <option value="LOGIN">Login</option>
                        <option value="LOGOUT">Logout</option>
                    </select>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Role</th>
                            <th>Action</th>
                            <th>Resource</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="auditList"></tbody>
                </table>
                <div id="noAuditLogs" class="no-data">No audit logs available</div>
                <div class="pagination-controls">
                    <select id="auditPerPage" onchange="changeAuditPerPage()">
                        <option value="10">10 per page</option>
                        <option value="25">25 per page</option>
                        <option value="50">50 per page</option>
                    </select>
                    <button class="pagination-btn" onclick="previousAuditPage()">&lt; Previous</button>
                    <span class="pagination-info" id="auditPaginationInfo">Page 1</span>
                    <button class="pagination-btn" onclick="nextAuditPage()">Next &gt;</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals remain the same -->
    <div id="userTypeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create User Type</h3>
                <span class="close" onclick="closeUserTypeModal()">&times;</span>
            </div>
            <form onsubmit="createUserType(event)">
                <div id="usertypeError"></div>
                <div class="form-group">
                    <label for="typRole">User Role Name *</label>
                    <input type="text" id="typRole" required placeholder="e.g., Manager, Supervisor">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUserTypeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="updateUserTypeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update User Type</h3>
                <span class="close" onclick="closeUpdateUserTypeModal()">&times;</span>
            </div>
            <form onsubmit="updateUserType(event)">
                <input type="hidden" id="updateTypId">
                <div class="form-group">
                    <label for="updateTypRole">User Role Name *</label>
                    <input type="text" id="updateTypRole" required placeholder="e.g., Manager, Supervisor">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUpdateUserTypeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content" style="width: 700px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Create New Employee</h3>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <form onsubmit="createUser(event)">
                <div class="modal-body">
                    <div id="userError"></div>
                    <div class="form-group">
                        <label for="usrUsername">Username *</label>
                        <input type="text" id="usrUsername" required placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label for="usrEmail">Email Address *</label>
                        <input type="email" id="usrEmail" required placeholder="employee@example.com">
                    </div>
                    <div class="form-group">
                        <label for="usrPassword">Password *</label>
                        <input type="password" id="usrPassword" required placeholder="Min 8 characters, 2 special chars"
                            onkeyup="checkPasswordStrength()">
                        <!-- Add password strength indicator -->
                        <div id="passwordStrength"></div>
                    </div>
                    <div class="form-group">
                        <label for="usrConfirmPassword">Confirm Password *</label>
                        <input type="password" id="usrConfirmPassword" required placeholder="Confirm password">
                    </div>
                    <div class="form-group">
                        <label for="usrUserType">User Type *</label>
                        <select id="usrUserType" required>
                            <option value="">Select a user type</option>
                        </select>
                    </div>

                    <h4 style="margin-top: 20px; margin-bottom: 15px; color: #667eea;">Module Permissions</h4>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="margin-bottom: 0; padding-bottom: 0;">
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px;"><i
                                    class="fas fa-folder"></i> Projects</div>
                            <div class="checkbox-group">
                                <div class="checkbox-item"><input type="checkbox" id="permProjView" data-module="Proj"
                                        data-action="View"><label for="permProjView" style="margin: 0;">View</label>
                                </div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjAdd" data-module="Proj"
                                        data-action="Add"><label for="permProjAdd" style="margin: 0;">Add</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjEdit" data-module="Proj"
                                        data-action="Edit"><label for="permProjEdit" style="margin: 0;">Edit</label>
                                </div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjDelete" data-module="Proj"
                                        data-action="Delete"><label for="permProjDelete"
                                        style="margin: 0;">Delete</label></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 0; padding-bottom: 0;">
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px;"><i
                                    class="fas fa-users"></i> Project Team</div>
                            <div class="checkbox-group">
                                <div class="checkbox-item"><input type="checkbox" id="permProjTeamView"
                                        data-module="Proj_team" data-action="View"><label for="permProjTeamView"
                                        style="margin: 0;">View</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjTeamAdd"
                                        data-module="Proj_team" data-action="Add"><label for="permProjTeamAdd"
                                        style="margin: 0;">Add</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjTeamEdit"
                                        data-module="Proj_team" data-action="Edit"><label for="permProjTeamEdit"
                                        style="margin: 0;">Edit</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjTeamDelete"
                                        data-module="Proj_team" data-action="Delete"><label for="permProjTeamDelete"
                                        style="margin: 0;">Delete</label></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 0; padding-bottom: 0;">
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px;"><i
                                    class="fas fa-file-alt"></i> Documents</div>
                            <div class="checkbox-group">
                                <div class="checkbox-item"><input type="checkbox" id="permProjDocView"
                                        data-module="Proj_doc" data-action="View"><label for="permProjDocView"
                                        style="margin: 0;">View</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjDocAdd"
                                        data-module="Proj_doc" data-action="Add"><label for="permProjDocAdd"
                                        style="margin: 0;">Add</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjDocEdit"
                                        data-module="Proj_doc" data-action="Edit"><label for="permProjDocEdit"
                                        style="margin: 0;">Edit</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjDocDelete"
                                        data-module="Proj_doc" data-action="Delete"><label for="permProjDocDelete"
                                        style="margin: 0;">Delete</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjDocDownload"
                                        data-module="Proj_doc" data-action="Download"><label for="permProjDocDownload"
                                        style="margin: 0;">Download</label></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 0; padding-bottom: 0;">
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px;"><i
                                    class="fas fa-comments"></i> Discussion</div>
                            <div class="checkbox-group">
                                <div class="checkbox-item"><input type="checkbox" id="permProjDisView"
                                        data-module="Proj_Dis_" data-action="View"><label for="permProjDisView"
                                        style="margin: 0;">View</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjDisAdd"
                                        data-module="Proj_Dis_" data-action="Add"><label for="permProjDisAdd"
                                        style="margin: 0;">Add</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjDisEdit"
                                        data-module="Proj_Dis_" data-action="Edit"><label for="permProjDisEdit"
                                        style="margin: 0;">Edit</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permProjDisDelete"
                                        data-module="Proj_Dis_" data-action="Delete"><label for="permProjDisDelete"
                                        style="margin: 0;">Delete</label></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 0; padding-bottom: 0;">
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px;"><i
                                    class="fas fa-tasks"></i> Tasks</div>
                            <div class="checkbox-group">
                                <div class="checkbox-item"><input type="checkbox" id="permTaskView" data-module="task"
                                        data-action="View"><label for="permTaskView" style="margin: 0;">View</label>
                                </div>
                                <div class="checkbox-item"><input type="checkbox" id="permTaskAdd" data-module="task"
                                        data-action="Add"><label for="permTaskAdd" style="margin: 0;">Add</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="permTaskEdit" data-module="task"
                                        data-action="Edit"><label for="permTaskEdit" style="margin: 0;">Edit</label>
                                </div>
                                <div class="checkbox-item"><input type="checkbox" id="permTaskDelete" data-module="task"
                                        data-action="Delete"><label for="permTaskDelete"
                                        style="margin: 0;">Delete</label></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Employee</button>
                </div>
            </form>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content" style="width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="detailModalTitle">Active Projects</h3>
                <span class="close" onclick="closeDetailModal()">&times;</span>
            </div>
            <div id="detailModalBody" style="padding: 20px;"></div>
        </div>
    </div>

    <div id="updateUserModal" class="modal">
        <div class="modal-content" style="width: 700px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Update Employee</h3>
                <span class="close" onclick="closeUpdateUserModal()">&times;</span>
            </div>
            <form onsubmit="updateUser(event)">
                <div id="updateUserError"></div>
                <input type="hidden" id="updateUserId">
                <div class="form-group">
                    <label for="updateUsername">Username</label>
                    <input type="text" id="updateUsername" readonly>
                </div>
                <div class="form-group">
                    <label for="updateEmail">Email Address</label>
                    <input type="email" id="updateEmail" readonly>
                </div>
                <div class="form-group">
                    <label for="updateUserType">User Type</label>
                    <select id="updateUserType"></select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUpdateUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // PHASE 1: SECURITY UTILITIES & FUNCTIONS
        // ============================================

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validatePasswordStrength(password) {
            const minLength = password.length >= 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const hasSpecialChars = /[!@#$%^&*()_+=\-\[\]{};:'",.<>?/\\|`~]/.test(password);

            // <CHANGE> Relaxed password requirements from 2 special characters to 1, making it more reasonable while maintaining security
            return minLength && hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChars;
        }

        function generateCSRFToken() {
            const token = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            sessionStorage.setItem('csrfToken', token);
            return token;
        }

        function checkPasswordStrength() {
            const password = document.getElementById('usrPassword').value;
            const strengthDiv = document.getElementById('passwordStrength');

            if (!password) {
                strengthDiv.innerHTML = '';
                return;
            }

            const minLength = password.length >= 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const hasSpecialChars = /[!@#$%^&*()_+=\-\[\]{};:'",.<>?/\\|`~]/.test(password);

            let strength = 'weak';
            let criteria = 0;

            if (minLength) criteria++;
            if (hasUpperCase) criteria++;
            if (hasLowerCase) criteria++;
            if (hasNumbers) criteria++;
            if (hasSpecialChars) criteria++;

            if (criteria >= 4) {
                strength = 'strong';
            } else if (criteria >= 3) {
                strength = 'medium';
            }

            const messages = {
                weak: ' Weak: Add uppercase, lowercase, numbers, and special characters',
                medium: ' Medium: Password is acceptable',
                strong: ' Strong: Password meets security requirements'
            };

            strengthDiv.className = `password-strength ${strength}`;
            strengthDiv.innerHTML = messages[strength];
        }

        // ============================================
        // PHASE 2: RBAC & AUDIT LOGGING SYSTEM
        // ============================================

        const rbacSystem = {
            currentRole: 'Super Admin',
            roles: {
                'Super Admin': {
                    permissions: {
                        users: ['create', 'read', 'update', 'delete', 'export'],
                        userTypes: ['create', 'read', 'update', 'delete'],
                        auditLogs: ['read', 'export', 'delete'],
                        dashboard: ['read']
                    }
                },
                'Admin': {
                    permissions: {
                        users: ['read', 'update'],
                        userTypes: ['read'],
                        auditLogs: ['read'],
                        dashboard: ['read']
                    }
                },
                'Manager': {
                    permissions: {
                        users: ['read'],
                        userTypes: ['read'],
                        auditLogs: [],
                        dashboard: ['read']
                    }
                },
                'Viewer': {
                    permissions: {
                        users: ['read'],
                        userTypes: [],
                        auditLogs: [],
                        dashboard: ['read']
                    }
                }
            },

            hasPermission(resource, action) {
                const perms = this.roles[this.currentRole]?.permissions[resource] || [];
                return perms.includes(action);
            },

            checkPermission(resource, action) {
                if (!this.hasPermission(resource, action)) {
                    showNotification('You don\'t have permission to perform this action', 'error');
                    return false;
                }
                return true;
            }
        };

        const auditLog = {
            logs: JSON.parse(localStorage.getItem('auditLogs')) || [],
            maxLogs: 1000,

            addEntry(action, resource, details = '') {
                const entry = {
                    timestamp: new Date().toLocaleString(),
                    user: document.getElementById('adminName').textContent || 'Unknown',
                    role: rbacSystem.currentRole,
                    action: action,
                    resource: resource,
                    details: sanitizeInput(details),
                    id: Date.now()
                };

                this.logs.unshift(entry);

                if (this.logs.length > this.maxLogs) {
                    this.logs.pop();
                }

                localStorage.setItem('auditLogs', JSON.stringify(this.logs));

                // Send to server
                fetch('/api/audit-log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': sessionStorage.getItem('csrfToken')
                    },
                    body: JSON.stringify(entry)
                }).catch(() => { /* Silent fail - log stored locally */ });
            },

            getFilteredLogs(searchTerm = '', actionFilter = '') {
                return this.logs.filter(log => {
                    const matchesSearch = !searchTerm || 
                        log.user.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        log.resource.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        log.details.toLowerCase().includes(searchTerm.toLowerCase());
                    
                    const matchesAction = !actionFilter || log.action === actionFilter;
                    
                    return matchesSearch && matchesAction;
                });
            },

            clear() {
                if (confirm('Are you sure you want to clear all audit logs? This cannot be undone.')) {
                    this.logs = [];
                    localStorage.setItem('auditLogs', JSON.stringify(this.logs));
                    displayAuditLogs();
                    showNotification('Audit logs cleared', 'success');
                    auditLog.addEntry('DELETE', 'Audit Logs', 'All logs cleared');
                }
            }
        };

        // ============================================
        // PHASE 3-4: NOTIFICATION & UI ENHANCEMENTS
        // ============================================

        function showNotification(message, type = 'success', duration = 4000) {
            const notificationEl = document.getElementById(type === 'success' ? 'successMessage' : 
                                                          type === 'error' ? 'errorMessage' :
                                                          type === 'info' ? 'infoMessage' : 'successMessage');
            
            notificationEl.textContent = message;
            notificationEl.style.display = 'block';

            setTimeout(() => {
                notificationEl.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => {
                    notificationEl.style.display = 'none';
                    notificationEl.style.animation = '';
                }, 300);
            }, duration);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        function initializeDarkMode() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        function applyRBACVisibility() {
            const userTypesCard = document.getElementById('manageUserTypesCard');
            const createEmployeeCard = document.getElementById('createEmployeeCard');
            const auditLogsCard = document.getElementById('auditLogsCard');
            const createUserTypeBtn = document.getElementById('createUserTypeBtn');
            const createUserBtn = document.getElementById('createUserBtn');
            const exportUserTypesBtn = document.getElementById('exportUserTypesBtn');
            const exportUsersBtn = document.getElementById('exportUsersBtn');
            const userTypesTab = document.getElementById('userTypesTab');
            const auditTab = document.getElementById('auditTab');
            const clearAuditBtn = document.getElementById('clearAuditBtn');

            // Super Admin: All features visible
            if (rbacSystem.currentRole === 'Super Admin') {
                document.getElementById('roleDisplay').textContent = 'Super Admin';
                return;
            }

            // Admin: Limited features
            if (rbacSystem.currentRole === 'Admin') {
                userTypesCard?.classList.add('rbac-hidden');
                createUserTypeBtn?.classList.add('rbac-hidden');
                userTypesTab?.classList.add('rbac-hidden');
                auditLogsCard?.classList.add('rbac-hidden');
                auditTab?.classList.add('rbac-hidden');
                clearAuditBtn?.classList.add('rbac-hidden');
                document.getElementById('roleDisplay').textContent = 'Admin';
                return;
            }

            // Manager & Viewer: Very limited
            userTypesCard?.classList.add('rbac-hidden');
            createEmployeeCard?.classList.add('rbac-hidden');
            createUserTypeBtn?.classList.add('rbac-hidden');
            createUserBtn?.classList.add('rbac-hidden');
            exportUserTypesBtn?.classList.add('rbac-hidden');
            exportUsersBtn?.classList.add('rbac-hidden');
            userTypesTab?.classList.add('rbac-hidden');
            auditLogsCard?.classList.add('rbac-hidden');
            auditTab?.classList.add('rbac-hidden');

            document.getElementById('roleDisplay').textContent = rbacSystem.currentRole;
        }

        // ============================================
        // PHASE 4: SEARCH, SORT, FILTER & PAGINATION
        // ============================================

        let currentUserPage = 1;
        let itemsPerPage = 10;
        let sortConfig = { field: 'id', direction: 'asc' };
        let filteredUsers = [];

        let currentUserTypePage = 1;
        let userTypesPerPage = 10;
        let userTypesSortConfig = { field: 'id', direction: 'asc' };
        let filteredUserTypes = [];

        let currentAuditPage = 1;
        let auditPerPage = 10;
        let filteredAuditLogs = [];

        function filterUsers() {
            const searchTerm = document.getElementById('usersSearch').value;
            const roleFilter = document.getElementById('roleFilter').value;
            const allUsers = JSON.parse(localStorage.getItem('users')) || [];

            filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.username.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.userType.toLowerCase().includes(searchTerm.toLowerCase());
                
                const matchesRole = !roleFilter || user.userType === roleFilter;
                
                return matchesSearch && matchesRole;
            });

            currentUserPage = 1;
            displayUsers();
        }

        function sortUsers(field) {
            if (sortConfig.field === field) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.field = field;
                sortConfig.direction = 'asc';
            }

            filteredUsers.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                const comparison = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                return sortConfig.direction === 'asc' ? comparison : -comparison;
            });

            currentUserPage = 1;
            displayUsers();
            updateSortIndicators();
        }

        function updateSortIndicators() {
            document.querySelectorAll('.table th .sort-indicator').forEach(el => {
                el.textContent = '';
            });

            const headerMap = {
                'id': 0,
                'username': 1,
                'email': 2,
                'usertype': 3,
                'created': 4
            };

            const columnIndex = headerMap[sortConfig.field];
            if (columnIndex !== undefined) {
                const header = document.querySelectorAll('.table th')[columnIndex];
                if (header) {
                    const indicator = header.querySelector('.sort-indicator');
                    if (indicator) {
                        indicator.textContent = sortConfig.direction === 'asc' ? ' ' : ' ';
                    }
                }
            }
        }

        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentUserPage = 1;
            displayUsers();
        }

        function nextPage() {
            const maxPages = Math.ceil(filteredUsers.length / itemsPerPage);
            if (currentUserPage < maxPages) {
                currentUserPage++;
                displayUsers();
            }
        }

        function previousPage() {
            if (currentUserPage > 1) {
                currentUserPage--;
                displayUsers();
            }
        }

        function exportUsersCSV() {
            if (!rbacSystem.checkPermission('users', 'export')) return;

            const headers = ['ID', 'Username', 'Email', 'User Type', 'Created At'];
            const rows = filteredUsers.map(user => [
                user.id,
                user.username,
                user.email,
                user.userType,
                user.createdAt
            ]);

            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            auditLog.addEntry('EXPORT', 'Users', `Exported ${filteredUsers.length} users`);
            showNotification(`Exported ${filteredUsers.length} users to CSV`, 'success');
        }

        function filterUserTypes() {
            const searchTerm = document.getElementById('userTypesSearch').value;
            const allUserTypes = JSON.parse(localStorage.getItem('userTypes')) || [];

            filteredUserTypes = allUserTypes.filter(type => 
                !searchTerm || type.role.toLowerCase().includes(searchTerm.toLowerCase())
            );

            currentUserTypePage = 1;
            displayUserTypes();
        }

        function sortUserTypes(field) {
            if (userTypesSortConfig.field === field) {
                userTypesSortConfig.direction = userTypesSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                userTypesSortConfig.field = field;
                userTypesSortConfig.direction = 'asc';
            }

            filteredUserTypes.sort((a, b) => {
                let aVal = a[field === 'role' ? 'role' : field];
                let bVal = b[field === 'role' ? 'role' : field];

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                const comparison = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                return userTypesSortConfig.direction === 'asc' ? comparison : -comparison;
            });

            displayUserTypes();
        }

        function changeUserTypesPerPage() {
            userTypesPerPage = parseInt(document.getElementById('userTypesPerPage').value);
            currentUserTypePage = 1;
            displayUserTypes();
        }

        function nextUserTypesPage() {
            const maxPages = Math.ceil(filteredUserTypes.length / userTypesPerPage);
            if (currentUserTypePage < maxPages) {
                currentUserTypePage++;
                displayUserTypes();
            }
        }

        function previousUserTypesPage() {
            if (currentUserTypePage > 1) {
                currentUserTypePage--;
                displayUserTypes();
            }
        }

        function exportUserTypesCSV() {
            if (!rbacSystem.checkPermission('userTypes', 'export')) return;

            const headers = ['ID', 'User Role', 'Created At'];
            const rows = filteredUserTypes.map(type => [
                type.id,
                type.role,
                type.createdAt
            ]);

            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `user_types_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            auditLog.addEntry('EXPORT', 'User Types', `Exported ${filteredUserTypes.length} user types`);
            showNotification(`Exported ${filteredUserTypes.length} user types to CSV`, 'success');
        }

        function filterAuditLogs() {
            const searchTerm = document.getElementById('auditSearch').value;
            const actionFilter = document.getElementById('actionFilter').value;

            filteredAuditLogs = auditLog.getFilteredLogs(searchTerm, actionFilter);
            currentAuditPage = 1;
            displayAuditLogs();
        }

        function changeAuditPerPage() {
            auditPerPage = parseInt(document.getElementById('auditPerPage').value);
            currentAuditPage = 1;
            displayAuditLogs();
        }

        function nextAuditPage() {
            const maxPages = Math.ceil(filteredAuditLogs.length / auditPerPage);
            if (currentAuditPage < maxPages) {
                currentAuditPage++;
                displayAuditLogs();
            }
        }

        function previousAuditPage() {
            if (currentAuditPage > 1) {
                currentAuditPage--;
                displayAuditLogs();
            }
        }

        function exportAuditLogsCSV() {
            if (!rbacSystem.checkPermission('auditLogs', 'export')) return;

            const headers = ['Timestamp', 'User', 'Role', 'Action', 'Resource', 'Details'];
            const rows = filteredAuditLogs.map(log => [
                log.timestamp,
                log.user,
                log.role,
                log.action,
                log.resource,
                log.details
            ]);

            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit_logs_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            auditLog.addEntry('EXPORT', 'Audit Logs', `Exported ${filteredAuditLogs.length} audit logs`);
            showNotification(`Exported ${filteredAuditLogs.length} audit logs to CSV`, 'success');
        }

        function clearAuditLogs() {
            if (!rbacSystem.checkPermission('auditLogs', 'delete')) return;
            auditLog.clear();
        }

        // ============================================
        // CORE DASHBOARD FUNCTIONS
        // ============================================

        function selectTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');

            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');

            if (tabId === 'users-tab') {
                if (filteredUsers.length === 0) {
                    filterUsers();
                }
                displayUsers();
            } else if (tabId === 'usertypes-tab') {
                if (filteredUserTypes.length === 0) {
                    filterUserTypes();
                }
                displayUserTypes();
            } else if (tabId === 'audit-tab') {
                if (filteredAuditLogs.length === 0) {
                    filterAuditLogs();
                }
                displayAuditLogs();
            }
        }

        function displayUsers() {
            if (!filteredUsers.length) {
                filterUsers();
                return;
            }

            const start = (currentUserPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedUsers = filteredUsers.slice(start, end);

            const usersList = document.getElementById('usersList');
            const noUsers = document.getElementById('noUsers');

            if (paginatedUsers.length === 0) {
                usersList.innerHTML = '';
                noUsers.style.display = 'block';
                document.getElementById('paginationInfo').textContent = 'No users found';
                return;
            }

            noUsers.style.display = 'none';
            usersList.innerHTML = paginatedUsers.map(user => `
                <tr>
                    <td>${sanitizeInput(user.id)}</td>
                    <td>${sanitizeInput(user.username)}</td>
                    <td>${sanitizeInput(user.email)}</td>
                    <td><span class="status-badge status-active">${sanitizeInput(user.userType)}</span></td>
                    <td>${sanitizeInput(user.createdAt)}</td>
                    <td>
                        <div class="table-actions">
                            ${rbacSystem.hasPermission('users', 'update') ? `<button class="btn btn-secondary btn-sm" onclick="openUpdateUserModal(${user.id})"><i class="fas fa-edit"></i></button>` : ''}
                            ${rbacSystem.hasPermission('users', 'delete') ? `<button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            const maxPages = Math.ceil(filteredUsers.length / itemsPerPage);
            document.getElementById('paginationInfo').textContent = 
                `Page ${currentUserPage} of ${maxPages} (Showing ${start + 1}-${Math.min(end, filteredUsers.length)} of ${filteredUsers.length})`;

            document.querySelector('[onclick="previousPage()"]').disabled = currentUserPage === 1;
            document.querySelector('[onclick="nextPage()"]').disabled = currentUserPage === maxPages;
        }

        function displayUserTypes() {
            if (!filteredUserTypes.length) {
                filterUserTypes();
                return;
            }

            const start = (currentUserTypePage - 1) * userTypesPerPage;
            const end = start + userTypesPerPage;
            const paginatedTypes = filteredUserTypes.slice(start, end);

            const userTypesList = document.getElementById('usertypesList');
            const noUserTypes = document.getElementById('noUserTypes');

            if (paginatedTypes.length === 0) {
                userTypesList.innerHTML = '';
                noUserTypes.style.display = 'block';
                document.getElementById('userTypesPaginationInfo').textContent = 'No user types found';
                return;
            }

            noUserTypes.style.display = 'none';
            userTypesList.innerHTML = paginatedTypes.map(type => `
                <tr>
                    <td>${sanitizeInput(type.id)}</td>
                    <td>${sanitizeInput(type.role)}</td>
                    <td>${sanitizeInput(type.createdAt)}</td>
                    <td>
                        <div class="table-actions">
                            ${rbacSystem.hasPermission('userTypes', 'update') ? `<button class="btn btn-secondary btn-sm" onclick="openUpdateUserTypeModal(${type.id})"><i class="fas fa-edit"></i></button>` : ''}
                            ${rbacSystem.hasPermission('userTypes', 'delete') ? `<button class="btn btn-danger btn-sm" onclick="deleteUserType(${type.id})"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            const maxPages = Math.ceil(filteredUserTypes.length / userTypesPerPage);
            document.getElementById('userTypesPaginationInfo').textContent = 
                `Page ${currentUserTypePage} of ${maxPages}`;

            document.querySelector('[onclick="previousUserTypesPage()"]').disabled = currentUserTypePage === 1;
            document.querySelector('[onclick="nextUserTypesPage()"]').disabled = currentUserTypePage === maxPages;
        }

        function displayAuditLogs() {
            const start = (currentAuditPage - 1) * auditPerPage;
            const end = start + auditPerPage;
            const paginatedLogs = filteredAuditLogs.slice(start, end);

            const auditList = document.getElementById('auditList');
            const noAuditLogs = document.getElementById('noAuditLogs');

            if (paginatedLogs.length === 0) {
                auditList.innerHTML = '';
                noAuditLogs.style.display = 'block';
                document.getElementById('auditPaginationInfo').textContent = 'No audit logs found';
                return;
            }

            noAuditLogs.style.display = 'none';
            auditList.innerHTML = paginatedLogs.map(log => `
                <tr>
                    <td>${sanitizeInput(log.timestamp)}</td>
                    <td>${sanitizeInput(log.user)}</td>
                    <td>${sanitizeInput(log.role)}</td>
                    <td><span class="status-badge status-active">${sanitizeInput(log.action)}</span></td>
                    <td>${sanitizeInput(log.resource)}</td>
                    <td>${sanitizeInput(log.details)}</td>
                </tr>
            `).join('');

            const maxPages = Math.ceil(filteredAuditLogs.length / auditPerPage);
            document.getElementById('auditPaginationInfo').textContent = 
                `Page ${currentAuditPage} of ${maxPages}`;

            document.querySelector('[onclick="previousAuditPage()"]').disabled = currentAuditPage === 1;
            document.querySelector('[onclick="nextAuditPage()"]').disabled = currentAuditPage === maxPages;
        }

        function openUserModal() {
            if (!rbacSystem.checkPermission('users', 'create')) return;
            document.getElementById('userModal').style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function createUser(event) {
            event.preventDefault();

            if (!rbacSystem.checkPermission('users', 'create')) return;

            const username = document.getElementById('usrUsername').value;
            const email = document.getElementById('usrEmail').value;
            const password = document.getElementById('usrPassword').value;
            const confirmPassword = document.getElementById('usrConfirmPassword').value;
            const userType = document.getElementById('usrUserType').value;

            if (!isValidEmail(email)) {
                showNotification('Invalid email format', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
          
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const newUser = {
                id: Date.now(),
                username: sanitizeInput(username),
                email: sanitizeInput(email),
                password: password, // In production, hash this server-side
                userType: sanitizeInput(userType),
                createdAt: new Date().toLocaleDateString()
            };

            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));

            auditLog.addEntry('CREATE', 'User', `Created new user: ${username}`);
            showNotification('Employee created successfully', 'success');
            closeUserModal();
            filterUsers();
        }

        function openUpdateUserModal(userId) {
            if (!rbacSystem.checkPermission('users', 'update')) return;

            const users = JSON.parse(localStorage.getItem('users')) || [];
            const user = users.find(u => u.id === userId);

            if (user) {
                document.getElementById('updateUserId').value = user.id;
                document.getElementById('updateUsername').value = user.username;
                document.getElementById('updateEmail').value = user.email;
                document.getElementById('updateUserType').value = user.userType;
                document.getElementById('updateUserModal').style.display = 'block';
            }
        }

        function closeUpdateUserModal() {
            document.getElementById('updateUserModal').style.display = 'none';
        }

        function updateUser(event) {
            event.preventDefault();

            if (!rbacSystem.checkPermission('users', 'update')) return;

            const userId = parseInt(document.getElementById('updateUserId').value);
            const newUserType = document.getElementById('updateUserType').value;

            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.id === userId);

            if (userIndex !== -1) {
                const oldUserType = users[userIndex].userType;
                users[userIndex].userType = sanitizeInput(newUserType);
                localStorage.setItem('users', JSON.stringify(users));

                auditLog.addEntry('UPDATE', 'User', `Updated user type from ${oldUserType} to ${newUserType}`);
                showNotification('Employee updated successfully', 'success');
                closeUpdateUserModal();
                filterUsers();
            }
        }

        function deleteUser(userId) {
            if (!rbacSystem.checkPermission('users', 'delete')) return;

            if (confirm('Are you sure you want to delete this employee?')) {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const user = users.find(u => u.id === userId);
                const filteredList = users.filter(u => u.id !== userId);
                localStorage.setItem('users', JSON.stringify(filteredList));

                auditLog.addEntry('DELETE', 'User', `Deleted user: ${user.username}`);
                showNotification('Employee deleted successfully', 'success');
                filterUsers();
            }
        }

        function openUserTypeModal() {
            if (!rbacSystem.checkPermission('userTypes', 'create')) return;
            document.getElementById('userTypeModal').style.display = 'block';
        }

        function closeUserTypeModal() {
            document.getElementById('userTypeModal').style.display = 'none';
        }

        function createUserType(event) {
            event.preventDefault();

            if (!rbacSystem.checkPermission('userTypes', 'create')) return;

            const role = document.getElementById('typRole').value;

            const userTypes = JSON.parse(localStorage.getItem('userTypes')) || [];
            const newUserType = {
                id: Date.now(),
                role: sanitizeInput(role),
                createdAt: new Date().toLocaleDateString()
            };

            userTypes.push(newUserType);
            localStorage.setItem('userTypes', JSON.stringify(userTypes));

            // Update user type select dropdowns
            updateUserTypeSelects();

            auditLog.addEntry('CREATE', 'User Type', `Created new user type: ${role}`);
            showNotification('User type created successfully', 'success');
            closeUserTypeModal();
            filterUserTypes();
        }

        function openUpdateUserTypeModal(typeId) {
            if (!rbacSystem.checkPermission('userTypes', 'update')) return;

            const userTypes = JSON.parse(localStorage.getItem('userTypes')) || [];
            const userType = userTypes.find(t => t.id === typeId);

            if (userType) {
                document.getElementById('updateTypId').value = userType.id;
                document.getElementById('updateTypRole').value = userType.role;
                document.getElementById('updateUserTypeModal').style.display = 'block';
            }
        }

        function closeUpdateUserTypeModal() {
            document.getElementById('updateUserTypeModal').style.display = 'none';
        }

        function updateUserType(event) {
            event.preventDefault();

            if (!rbacSystem.checkPermission('userTypes', 'update')) return;

            const typeId = parseInt(document.getElementById('updateTypId').value);
            const newRole = document.getElementById('updateTypRole').value;

            const userTypes = JSON.parse(localStorage.getItem('userTypes')) || [];
            const typeIndex = userTypes.findIndex(t => t.id === typeId);

            if (typeIndex !== -1) {
                const oldRole = userTypes[typeIndex].role;
                userTypes[typeIndex].role = sanitizeInput(newRole);
                localStorage.setItem('userTypes', JSON.stringify(userTypes));

                updateUserTypeSelects();

                auditLog.addEntry('UPDATE', 'User Type', `Updated from ${oldRole} to ${newRole}`);
                showNotification('User type updated successfully', 'success');
                closeUpdateUserTypeModal();
                filterUserTypes();
            }
        }

        function deleteUserType(typeId) {
            if (!rbacSystem.checkPermission('userTypes', 'delete')) return;

            if (confirm('Are you sure you want to delete this user type?')) {
                const userTypes = JSON.parse(localStorage.getItem('userTypes')) || [];
                const userType = userTypes.find(t => t.id === typeId);
                const filteredList = userTypes.filter(t => t.id !== typeId);
                localStorage.setItem('userTypes', JSON.stringify(filteredList));

                auditLog.addEntry('DELETE', 'User Type', `Deleted user type: ${userType.role}`);
                showNotification('User type deleted successfully', 'success');
                filterUserTypes();
            }
        }

        function updateUserTypeSelects() {
            const userTypes = JSON.parse(localStorage.getItem('userTypes')) || [];
            const select = document.getElementById('usrUserType');
            const updateSelect = document.getElementById('updateUserType');
            const roleFilter = document.getElementById('roleFilter');

            select.innerHTML = '<option value="">Select a user type</option>';
            updateSelect.innerHTML = '';
            roleFilter.innerHTML = '<option value="">All Roles</option>';

            userTypes.forEach(type => {
                const option1 = document.createElement('option');
                option1.value = type.role;
                option1.textContent = type.role;
                select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = type.role;
                option2.textContent = type.role;
                updateSelect.appendChild(option2);

                const option3 = document.createElement('option');
                option3.value = type.role;
                option3.textContent = type.role;
                roleFilter.appendChild(option3);
            });
        }

        function showDetailModal(type) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('detailModalTitle');
            const body = document.getElementById('detailModalBody');

            const details = {
                active_projects: { title: 'Active Projects', content: '<p>5 active projects are currently running.</p>' },
                completed_tasks: { title: 'Completed Tasks', content: '<p>42 tasks have been completed.</p>' },
                active_tasks: { title: 'Active Tasks', content: '<p>18 tasks are currently in progress.</p>' },
                overdue_tasks: { title: 'Overdue Tasks', content: '<p>2 tasks are overdue.</p>' },
                pending_approvals: { title: 'Pending Approvals', content: '<p>7 items are pending approval.</p>' }
            };

            if (details[type]) {
                title.textContent = details[type].title;
                body.innerHTML = details[type].content;
                modal.style.display = 'block';
            }
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function performAdminSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            console.log('[v0] Admin search:', searchTerm);
        }

        function logout() {
            auditLog.addEntry('LOGOUT', 'Session', 'User logged out');
            showNotification('Logged out successfully', 'success');
            setTimeout(() => {
                window.location.href = '/login';
            }, 1500);
        }

        window.addEventListener('DOMContentLoaded', () => {
            initializeDarkMode();
            generateCSRFToken();
            applyRBACVisibility();
            updateUserTypeSelects();
            filterUsers();
            filterUserTypes();
            filterAuditLogs();
            
            auditLog.addEntry('LOGIN', 'Session', 'User logged in');
        });

        window.addEventListener('click', (event) => {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>
