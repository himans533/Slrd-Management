<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Dashboard - Project Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px 0;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.98);
            padding: 24px 30px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .company-logo {
            height: 50px;
            width: auto;
            max-width: 150px;
            object-fit: contain;
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
            min-width: 250px;
            max-width: 500px;
            position: relative;
        }

        .search-container input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-container input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-result-item:hover {
            background: #f7fafc;
        }

        .dashboard-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin: 0;
            flex: 1;
        }

        .header-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            object-fit: cover;
            overflow: hidden;
            cursor: pointer;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details h3 {
            margin: 0;
            color: #2d3748;
            font-size: 1rem;
        }

        .user-details p {
            margin: 0;
            color: #718096;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .company-logo {
            height: 50px;
            width: auto;
            max-width: 150px;
            object-fit: contain;
            margin-right: 15px;
        }

        .tabs-nav {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px 12px 0 0;
            padding: 0 20px;
        }

        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover {
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 0 0 16px 16px;
            padding: 30px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }

        .tab-content.active {
            display: block;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 25px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-card p {
            margin: 0;
            opacity: 0.9;
        }

        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .content-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .content-card h4 {
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-picture-container {
            text-align: center;
            cursor: pointer;
            position: relative;
            display: inline-block;
            margin: 0 auto 20px;
            width: 100%;
        }

        .profile-picture-container .user-avatar {
            width: 150px;
            /* Increased from 120px */
            height: 150px;
            /* Increased from 120px */
            font-size: 3rem;

            margin: 0 auto 15px;
            border: 4px solid #667eea;
            /* Thicker border */
            position: relative;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            overflow: hidden;
            transition: all 0.4s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .picture-overlay {
            position: absolute;
            top: 25px;
            right: calc(50% - 75px + 50px);
            /* Adjusted for new avatar size */
            background: linear-gradient(135deg, #764ba2, #667eea);
            color: white;
            border-radius: 50%;
            width: 45px;
            /* Increased from 40px */
            height: 45px;
            /* Increased from 40px */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            /* Increased from 1.2rem */
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            border: 3px solid white;
            z-index: 10;
            transition: all 0.3s ease;
        }


        .picture-overlay:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .profile-picture-container:hover .user-avatar {
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transform: scale(1.08);
            border-color: #764ba2;
        }

        /* Profile avatar image */
        .profile-picture-container .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }



        .avatar-input {
            display: none;
        }


        .items-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .item-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            transition: all 0.3s ease;
        }

        .item-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
        }

        .item-content {
            flex: 1;
        }

        .item-content h5 {
            color: #2d3748;
            font-weight: 600;
            margin: 0 0 5px 0;
        }

        .item-content p {
            margin: 0 0 10px 0;
            color: #718096;
            font-size: 0.95rem;
        }

        .item-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.85rem;
            color: #718096;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
            min-width: 150px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge-info {
            background: #bee3f8;
            color: #2c5282;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 2px solid #e2e8f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-color: #48bb78;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border-color: #f56565;
        }

        /* Added Cropper modal styles for image cropping interface */
        .cropper-modal-content {
            max-width: 800px;
        }

        .cropper-container-wrapper {
            background: #f7fafc;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            height: 500px;
        }

        .cropper-img {
            display: block;
            max-width: 100%;
        }

        .cropper-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .cropper-control-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cropper-control-btn:hover {
            background: #667eea;
            color: white;
        }

        .team-members-section {
            background: #f0f4ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .team-members-section h5 {
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .team-member-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .team-member-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .team-member-checkbox:hover {
            background: #f7fafc;
        }

        .team-member-checkbox input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .team-member-info {
            display: flex;
            flex-direction: column;
        }

        .team-member-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .team-member-email {
            color: #718096;
            font-size: 0.8rem;
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .permission-module {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .permission-module h5 {
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .permission-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .permission-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .permission-badge.granted {
            background: #c6f6d5;
            color: #22543d;
        }

        .permission-badge.denied {
            background: #fed7d7;
            color: #742a2a;
            opacity: 0.6;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h4 {
            color: #2d3748;
            margin: 20px 0 10px 0;
        }

        /* Added styles for real-time stats */
        .real-time-stat {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
        }

        .real-time-stat h6 {
            color: #2d3748;
            font-size: 0.85rem;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .time-display {
            font-size: 1.1rem;
            font-weight: 700;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .countdown {
            font-family: 'Courier New', monospace;
        }

        .progress {
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            transition: width 0.5s ease;
        }

        .real-time-update {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }

            .dashboard-header {
                flex-direction: column;
                text-align: center;
                padding: 20px;
                margin-bottom: 25px;
            }

            .header-left {
                flex: 1 1 100%;
            }

            .header-user-info {
                flex: 1 1 100%;
                justify-content: center;
                margin-top: 15px;
            }

            .dashboard-header h1 {
                font-size: 1.8rem;
                margin-bottom: 15px;
            }

            .search-container {
                max-width: none;
                margin-bottom: 15px;
            }

            .tabs-nav {
                padding: 0 15px;
                flex-wrap: wrap;
            }

            .tab-button {
                padding: 12px 18px;
                font-size: 13px;
                flex: 1;
                min-width: 120px;
            }

            .tab-content {
                padding: 25px;
            }

            .row {
                margin-bottom: 25px;
            }

            .stat-card {
                margin-bottom: 15px;
                padding: 20px;
            }

            .stat-card h3 {
                font-size: 2rem;
            }

            .content-card {
                padding: 15px;
            }

            .content-card h4 {
                font-size: 1.1rem;
            }

            .items-list {
                gap: 12px;
            }

            .item-card {
                flex-direction: column;
                padding: 15px;
                gap: 15px;
            }

            .item-content h5 {
                font-size: 1rem;
            }

            .item-actions {
                width: 100%;
                justify-content: center;
                gap: 8px;
            }

            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 25px;
            }

            .modal-header h3 {
                font-size: 18px;
            }

            .team-member-list {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .team-member-checkbox {
                padding: 8px;
            }

            .permissions-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .permission-module {
                padding: 15px;
            }

            .permission-actions {
                gap: 6px;
            }

            .permission-badge {
                padding: 4px 10px;
                font-size: 0.8rem;
            }

            /* Responsive adjustments for cropper modal */
            .cropper-modal-content {
                width: 95%;
            }

            .cropper-container-wrapper {
                height: 300px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px 0;
            }

            .dashboard-container {
                padding: 10px;
            }

            .dashboard-header {
                padding: 15px;
                margin-bottom: 20px;
            }

            .dashboard-header h1 {
                font-size: 1.5rem;
            }

            .company-logo {
                height: 40px;
                width: auto;
                max-width: 120px;
            }

            .search-container input {
                font-size: 16px;
                /* Prevents zoom on iOS */
            }

            .header-user-info {
                margin-top: 10px;
            }

            .user-avatar {
                width: 35px;
                height: 35px;
            }

            .user-details h3 {
                font-size: 13px;
            }

            .user-details p {
                font-size: 11px;
            }

            .logout-btn {
                padding: 8px 16px;
                font-size: 13px;
            }

            .tabs-nav {
                padding: 0 10px;
            }

            .tab-button {
                padding: 10px 12px;
                font-size: 12px;
                min-width: 100px;
            }

            .tab-content {
                padding: 20px;
            }

            .stat-card {
                padding: 15px;
                min-height: 80px;
            }

            .stat-card h3 {
                font-size: 1.5rem;
            }

            .stat-card p {
                font-size: 0.9rem;
            }

            .content-card {
                padding: 12px;
            }

            .content-card h4 {
                font-size: 1rem;
                margin-bottom: 12px;
            }

            .item-card {
                padding: 12px;
            }

            .item-content h5 {
                font-size: 0.95rem;
            }

            .item-meta {
                gap: 12px;
                font-size: 0.8rem;
            }

            .modal-content {
                width: 98%;
                margin: 2% auto;
                padding: 20px;
            }

            .modal-header {
                padding-bottom: 15px;
            }

            .modal-header h3 {
                font-size: 16px;
            }

            .modal-close {
                width: 25px;
                height: 25px;
                font-size: 1rem;
            }

            .modal-body {
                padding: 20px;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 16px;
                /* Prevents zoom on iOS */
                padding: 12px 15px;
            }

            .modal-footer {
                padding: 15px;
                gap: 8px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            .team-members-section h5 {
                font-size: 1rem;
            }

            .team-member-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .team-member-name {
                font-size: 0.85rem;
            }

            .team-member-email {
                font-size: 0.8rem;
            }

            .permissions-grid {
                gap: 12px;
            }

            .permission-module h5 {
                font-size: 1rem;
                margin-bottom: 12px;
            }

            .empty-state i {
                font-size: 2.5rem;
            }

            .empty-state h4 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="header-left">
                <img src="../static/lg.png" alt="Company Logo" class="company-logo" />
                <h1>Employee Dashboard</h1>
            </div>
            <div class="search-container">
                <i class="fas fa-search" style="color: #718096"></i>
                <input type="text" id="adminSearchInput" placeholder="Search projects, tasks, team members..." />
                <div id="searchResults" class="search-results"></div>
            </div>
            <div class="header-user-info">
                <div class="user-avatar-container">
                    <img id="headerAvatarImg" class="user-avatar" style="display: none;" alt="User Avatar" />
                    <div id="headerAvatarInitials" class="user-avatar">ED</div>
                </div>
                <div class="user-details">
                    <h3 id="userName">Employee Name</h3>
                    <p id="userRole">Employee</p>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="tabs-nav">
            <button class="tab-button active" onclick="selectTab('overview-tab', event)">
                <i class="fas fa-th-large"></i> Overview
            </button>
            <button class="tab-button" id="projectsTabBtn" onclick="selectTab('projects-tab', event)">
                <i class="fas fa-project-diagram"></i> Projects
            </button>
            <button class="tab-button" id="tasksTabBtn" onclick="selectTab('tasks-tab', event)">
                <i class="fas fa-tasks"></i> Tasks
            </button>
            <button class="tab-button" id="milestonesTabBtn" onclick="selectTab('milestones-tab', event)">
                <i class="fas fa-flag"></i> Milestones
            </button>
            <button class="tab-button" id="documentsTabBtn" onclick="selectTab('documents-tab', event)">
                <i class="fas fa-file-alt"></i> Documents
            </button>
            <button class="tab-button" id="activitiesTabBtn" onclick="selectTab('activities-tab', event)">
                <i class="fas fa-history"></i> Recent Activity
            </button>
            <button class="tab-button" id="settingsTabBtn" onclick="selectTab('settings-tab', event)">
                <i class="fas fa-cog"></i> Settings
            </button>
            <button class="tab-button" id="profileTabBtn" onclick="selectTab('profile-tab', event)">
                <i class="fas fa-user"></i> Profile
            </button>
        </div>

        <div id="overview-tab" class="tab-content active">
            <div class="row" style="margin-bottom: 30px">
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="stat-card">
                        <i class="fas fa-folder"></i>
                        <h3 id="statProjects">0</h3>
                        <p>Total Projects</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="stat-card">
                        <i class="fas fa-tasks"></i>
                        <h3 id="statTasks">0</h3>
                        <p>Total Tasks</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <h3 id="statCompleted">0</h3>
                        <p>Completed Tasks</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="stat-card">
                        <i class="fas fa-flag"></i>
                        <h3 id="statMilestones">0</h3>
                        <p>Total Milestones</p>
                    </div>
                </div>
            </div>
            <div class="content-card">
                <h4><i class="fas fa-list-check"></i> Quick Actions</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap">
                    <button class="btn btn-primary" id="quickCreateProject" onclick="openCreateProjectModal()"
                        style="display: none">
                        <i class="fas fa-plus"></i> Create Project
                    </button>
                    <button class="btn btn-primary" id="quickCreateTask" onclick="openCreateTaskModal()"
                        style="display: none">
                        <i class="fas fa-plus"></i> Create Task
                    </button>
                    <button class="btn btn-primary" id="quickCreateMilestone" onclick="openCreateMilestoneModal()"
                        style="display: none">
                        <i class="fas fa-plus"></i> Create Milestone
                    </button>
                    <button class="btn btn-primary" id="quickUploadDocument" onclick="openUploadDocumentModal()"
                        style="display: none">
                        <i class="fas fa-upload"></i> Upload Document
                    </button>
                </div>
            </div>

            <!-- Add this in the overview tab after "Quick Actions" section -->
            <div class="content-card">
                <h4><i class="fas fa-chart-line"></i> Real-Time Project Progress</h4>
                <div id="realTimeProjects" class="items-list">
                    <div class="empty-state" id="noActiveProjects">
                        <i class="fas fa-folder-open"></i>
                        <h4>No active projects</h4>
                        <p>Create your first project to see real-time updates</p>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <h4>
                    <i class="fas fa-project-diagram"></i> Recent Projects
                </h4>
                <div id="recentActivity" class="items-list"></div>
                <div id="noActivity" class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h4>No recent projects</h4>
                    <p>Create your first project to get started!</p>
                </div>
            </div>
        </div>

        <div id="projects-tab" class="tab-content">
            <div style="margin-bottom: 20px">
                <button class="btn btn-primary" id="createProjectBtn" onclick="openCreateProjectModal()"
                    style="display: none">
                    <i class="fas fa-plus"></i> Create Project
                </button>
            </div>
            <div id="projectsList" class="items-list"></div>
            <div id="noProjects" class="empty-state" style="display: none">
                <i class="fas fa-folder-open"></i>
                <h4>No projects assigned</h4>
                <p>You don't have any projects assigned yet.</p>
            </div>
        </div>

        <div id="tasks-tab" class="tab-content">
            <div style="margin-bottom: 20px">
                <button class="btn btn-primary" id="createTaskBtn" onclick="openCreateTaskModal()"
                    style="display: none">
                    <i class="fas fa-plus"></i> Create Task
                </button>
            </div>
            <div id="tasksList" class="items-list"></div>
            <div id="noTasks" class="empty-state" style="display: none">
                <i class="fas fa-tasks"></i>
                <h4>No tasks assigned</h4>
                <p>You don't have any tasks assigned yet.</p>
            </div>
        </div>

        <div id="milestones-tab" class="tab-content">
            <div style="margin-bottom: 20px">
                <button class="btn btn-primary" id="createMilestoneBtn" onclick="openCreateMilestoneModal()"
                    style="display: none">
                    <i class="fas fa-plus"></i> Create Milestone
                </button>
            </div>
            <div id="milestonesList" class="items-list"></div>
            <div id="noMilestones" class="empty-state" style="display: none">
                <i class="fas fa-flag"></i>
                <h4>No milestones</h4>
                <p>No milestones have been created yet.</p>
            </div>
        </div>

        <div id="documents-tab" class="tab-content">
            <div style="margin-bottom: 20px">
                <button class="btn btn-primary" id="uploadDocumentBtn" onclick="openUploadDocumentModal()"
                    style="display: none">
                    <i class="fas fa-upload"></i> Upload Document
                </button>
            </div>
            <div id="documentsList" class="items-list"></div>
            <div id="noDocuments" class="empty-state" style="display: none">
                <i class="fas fa-file-alt"></i>
                <h4>No documents</h4>
                <p>No documents have been uploaded yet.</p>
            </div>
        </div>

        <div id="activities-tab" class="tab-content">
            <h4 style="color: #2d3748; margin-bottom: 20px">
                <i class="fas fa-history"></i> Recent Activities
            </h4>
            <div id="activitiesList" class="items-list"></div>
            <div id="noActivities" class="empty-state" style="display: none">
                <i class="fas fa-history"></i>
                <h4>No recent activities</h4>
                <p>Your recent activities will appear here.</p>
            </div>
        </div>

        <div id="permissions-tab" class="tab-content">
            <h4 style="color: #2d3748; margin-bottom: 20px">
                <i class="fas fa-shield-alt"></i> Your Module Permissions
            </h4>
            <div id="permissionsGrid" class="permissions-grid"></div>
            <div id="noPermissions" class="empty-state" style="display: none">
                <i class="fas fa-lock"></i>
                <h4>No permissions assigned</h4>
                <p>Contact your administrator to get permissions.</p>
            </div>
        </div>

        <div id="settings-tab" class="tab-content">
            <div class="row">
                <div class="col-md-8">
                    <div class="content-card" style="margin-bottom: 20px">
                        <h4 style="color: #667eea; margin-bottom: 10px">
                            <i class="fas fa-cog"></i> General Settings
                        </h4>
                        <p style="color: #718096; margin-bottom: 0">
                            Manage system settings and configurations
                        </p>
                    </div>

                    <div class="content-card" style="
                                margin-bottom: 20px;
                                border-left-color: #ffc107;
                            ">
                        <div style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    flex-wrap: wrap;
                                    gap: 15px;
                                ">
                            <div>
                                <h4 style="
                                            color: #ffc107;
                                            margin-bottom: 5px;
                                        ">
                                    <i class="fas fa-star"></i> Your Skills
                                </h4>
                                <p style="color: #718096; margin-bottom: 0">
                                    Manage your professional skills for
                                    better task matching
                                </p>
                            </div>
                            <button class="btn btn-primary" onclick="openManageSkillsModal()">
                                <i class="fas fa-plus"></i> Manage Skills
                            </button>
                        </div>
                    </div>

                    <div class="content-card" style="border-left-color: #9c27b0">
                        <h4 style="color: #9c27b0; margin-bottom: 10px">
                            <i class="fas fa-shield-alt"></i> Your
                            Permissions
                        </h4>
                        <p style="color: #718096; margin-bottom: 15px">
                            View your assigned module permissions
                        </p>
                        <button class="btn" onclick="selectTab('permissions-tab', event)"
                            style="background: #9c27b0; color: white">
                            <i class="fas fa-eye"></i> View Permissions
                        </button>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="content-card" style="border-left-color: #17a2b8">
                        <h4 style="color: #17a2b8; margin-bottom: 15px">
                            <i class="fas fa-users"></i> Current User Types
                        </h4>
                        <div id="userTypesDisplay">
                            <div class="empty-state" style="padding: 20px">
                                <i class="fas fa-users" style="font-size: 2rem; opacity: 0.5"></i>
                                <p style="margin-top: 10px">
                                    No custom user types created yet
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="profile-tab" class="tab-content">
            <div class="row">
                <div class="col-md-4">
                    <div class="content-card" style="text-align: center; padding: 30px">
                        <!-- Update profile avatar display to include image upload -->
                        <div class="profile-picture-container" onclick="triggerAvatarInput()">
                            <img id="profileAvatarImg" class="user-avatar"
                                src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNlMmU4ZjAiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxNSIgZmlsbD0iI2EwYWVjMCIvPgogIDxwYXRoIGQ9Ik0yMCA4NTAgTDIwIDY1IFE2NSA2NSAzNSA4NTAgTDM1IDY1IFE2NSA2NSA4NTAgT20wIDUwWiIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPg=="
                                alt="Profile Picture" style="display: none;">
                            <div class="user-avatar" id="profileAvatar" style="
                            width: 100px;
                            height: 100px;
                            font-size: 2.5rem;
                            margin: 0 auto 10px;
                        "></div>
                            <div class="picture-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <input type="file" id="avatarInput" class="avatar-input" accept="image/*"
                            onchange="handleAvatarSelect(event)">

                        <h3 id="profileName" style="color: #2d3748; margin-bottom: 5px">
                            Loading...
                        </h3>
                        <p id="profileRole" style="
                        color: #667eea;
                        font-weight: 600;
                        margin-bottom: 10px;
                    ">
                            Employee
                        </p>
                        <p id="profileEmail" style="color: #718096; font-size: 0.9rem">
                            -
                        </p>
                        <p id="profileDepartment" style="
                        color: #718096;
                        font-size: 0.9rem;
                        margin-top: 5px;
                    ">
                            -
                        </p>

                        <div style="margin-top: 15px;">
                            <button class="btn btn-sm btn-danger" onclick="deleteProfilePicture()">
                                <i class="fas fa-trash"></i> Remove Picture
                            </button>
                        </div>
                    </div>

                    <div class="content-card" style="margin-top: 20px">
                        <h4 style="color: #2d3748; margin-bottom: 15px">
                            <i class="fas fa-star" style="color: #ffc107"></i>
                            Your Skills
                        </h4>
                        <div id="profileSkillsList" style="display: flex; flex-wrap: wrap; gap: 8px">
                            <span style="color: #718096">No skills added yet</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="content-card">
                        <h4 style="color: #2d3748; margin-bottom: 20px">
                            <i class="fas fa-edit"></i> Edit Profile
                        </h4>
                        <form id="profileForm" onsubmit="updateProfile(event)">
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" id="profilePhone" placeholder="Enter phone number" />
                            </div>
                            <div class="form-group">
                                <label>Department</label>
                                <input type="text" id="profileDeptInput" placeholder="Enter department" />
                            </div>
                            <div class="form-group">
                                <label>Bio</label>
                                <textarea id="profileBio" placeholder="Tell us about yourself..." rows="4"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </form>
                    </div>

                    <div class="content-card" style="margin-top: 20px">
                        <h4 style="color: #2d3748; margin-bottom: 15px">
                            <i class="fas fa-chart-bar"></i> Activity
                            Statistics
                        </h4>
                        <div class="row">
                            <div class="col-6 col-md-3 mb-3">
                                <div style="
                                            background: #f0f4ff;
                                            padding: 15px;
                                            border-radius: 10px;
                                            text-align: center;
                                        ">
                                    <h3 id="profileStatProjects" style="color: #667eea; margin: 0">
                                        0
                                    </h3>
                                    <small style="color: #718096">Projects</small>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div style="
                                            background: #e8f5e9;
                                            padding: 15px;
                                            border-radius: 10px;
                                            text-align: center;
                                        ">
                                    <h3 id="profileStatCompleted" style="color: #28a745; margin: 0">
                                        0
                                    </h3>
                                    <small style="color: #718096">Completed</small>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div style="
                                            background: #fff3e0;
                                            padding: 15px;
                                            border-radius: 10px;
                                            text-align: center;
                                        ">
                                    <h3 id="profileStatPending" style="color: #ff9800; margin: 0">
                                        0
                                    </h3>
                                    <small style="color: #718096">Pending</small>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div style="
                                            background: #fce4ec;
                                            padding: 15px;
                                            border-radius: 10px;
                                            text-align: center;
                                        ">
                                    <h3 id="profileStatMilestones" style="color: #e91e63; margin: 0">
                                        0
                                    </h3>
                                    <small style="color: #718096">Milestones</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Replace the createProjectModal section with this enhanced version -->
    <div id="createProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-folder-plus"></i> Create New Project</h3>
                <button class="modal-close" onclick="closeModal('createProjectModal')">&times;</button>
            </div>
            <form id="createProjectForm" onsubmit="createProject(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Project Title *</label>
                        <input type="text" id="projectTitle" required placeholder="Enter project title" />
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="projectDescription" placeholder="Enter project description"></textarea>
                    </div>

                    <!-- New Fields: Creation Date, Deadline, and Reporting Time -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Creation Date</label>
                                <input type="date" id="projectCreationDate" value="<?php echo date('Y-m-d'); ?>"
                                    readonly />
                                <small class="form-text text-muted">Auto-filled with today's date</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Deadline *</label>
                                <input type="date" id="projectDeadline" required min="<?php echo date('Y-m-d'); ?>" />
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Daily Reporting Time *</label>
                        <input type="time" id="projectReportingTime" required value="09:00" />
                        <small class="form-text text-muted">Time when daily progress reports are expected</small>
                    </div>

                    <div class="team-members-section">
                        <button type="button" class="btn btn-primary" style="width: 100%; margin-bottom: 15px"
                            onclick="openAddTeamMemberModal()">
                            <i class="fas fa-user-plus"></i> Add New Team Member
                        </button>
                    </div>

                    <div class="team-members-section">
                        <h5><i class="fas fa-users"></i> Assign Existing Team Members</h5>
                        <div id="teamMembersList"></div>
                        <div id="newTeamMembersDisplay" style="margin-top: 15px; display: none;">
                            <h6>New Members Added:</h6>
                            <ul id="newTeamMembersList"></ul>
                        </div>
                    </div>

                    <!-- Real-time status display for the new project -->
                    <div id="newProjectStatus" class="alert alert-info" style="display: none; margin-top: 15px;">
                        <i class="fas fa-sync fa-spin"></i>
                        <span id="statusMessage">Creating project...</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('createProjectModal')"
                        style="background: #e2e8f0; color: #2d3748">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i> Create Project
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Create New Task</h3>
                <button class="modal-close" onclick="closeModal('createTaskModal')">&times;</button>
            </div>
            <form onsubmit="createTask(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Task Title *</label><input type="text" id="taskTitle" required
                            placeholder="Enter task title" />
                    </div>
                    <div class="form-group">
                        <label>Description</label><textarea id="taskDescription"
                            placeholder="Enter task description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Project *</label><select id="taskProject" required>
                            <option value="">Select a project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Assign To</label><select id="taskAssignee">
                            <option value="">Unassigned</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priority</label><select id="taskPriority">
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Deadline</label><input type="date" id="taskDeadline" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('createTaskModal')"
                        style="background: #e2e8f0; color: #2d3748">
                        Cancel</button><button type="submit" class="btn btn-primary">
                        Create Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="createMilestoneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-flag"></i> Create New Milestone</h3>
                <button class="modal-close" onclick="closeModal('createMilestoneModal')">&times;</button>
            </div>
            <form onsubmit="createMilestone(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Milestone Title *</label><input type="text" id="milestoneTitle" required
                            placeholder="Enter milestone title" />
                    </div>
                    <div class="form-group">
                        <label>Description</label><textarea id="milestoneDescription"
                            placeholder="Enter milestone description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Project *</label><select id="milestoneProject" required>
                            <option value="">Select a project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Due Date</label><input type="date" id="milestoneDueDate" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('createMilestoneModal')"
                        style="background: #e2e8f0; color: #2d3748">
                        Cancel</button><button type="submit" class="btn btn-primary">
                        Create Milestone
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="uploadDocumentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-upload"></i> Upload Document</h3>
                <button class="modal-close" onclick="closeModal('uploadDocumentModal')">&times;</button>
            </div>
            <form onsubmit="uploadDocument(event)" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Select File *</label><input type="file" id="documentFile" required />
                    </div>
                    <div class="form-group">
                        <label>Project *</label><select id="documentProject" required>
                            <option value="">Select a project</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('uploadDocumentModal')"
                        style="background: #e2e8f0; color: #2d3748">
                        Cancel</button><button type="submit" class="btn btn-primary">
                        Upload Document
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="manageSkillsModal" class="modal">
        <div class="modal-content" style="max-width: 800px">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-star"></i> Your Professional Skills
                </h3>
                <button class="modal-close" onclick="closeModal('manageSkillsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #718096; margin-bottom: 20px">
                    Add skills to help with task matching and assignment
                    optimization
                </p>

                <div class="row">
                    <div class="col-md-8">
                        <div class="content-card" style="margin-bottom: 20px">
                            <h5 style="color: #2d3748; margin-bottom: 15px">
                                Add New Skill
                            </h5>
                            <div style="display: flex; gap: 10px">
                                <input type="text" id="newSkillInput" class="form-control"
                                    placeholder="e.g., JavaScript, Project Management, Design" style="
                                            flex: 1;
                                            padding: 10px 15px;
                                            border: 2px solid #e2e8f0;
                                            border-radius: 8px;
                                        "
                                    onkeypress="if(event.key === 'Enter') { event.preventDefault(); addSkill(); }" />
                                <button class="btn btn-primary" onclick="addSkill()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>

                        <div class="content-card">
                            <h5 style="color: #2d3748; margin-bottom: 15px">
                                Current Skills
                            </h5>
                            <div id="currentSkillsList" style="min-height: 150px">
                                <div class="empty-state" style="padding: 30px">
                                    <i class="fas fa-star" style="
                                                font-size: 2rem;
                                                color: #ffc107;
                                                opacity: 0.5;
                                            "></i>
                                    <p style="
                                                margin-top: 10px;
                                                color: #718096;
                                            ">
                                        No skills added yet. Add your first
                                        skill above!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="content-card" style="
                                    background: #f0f4ff;
                                    border-left-color: #667eea;
                                ">
                            <h5 style="color: #667eea; margin-bottom: 15px">
                                <i class="fas fa-lightbulb"></i> Skill
                                Matching
                            </h5>

                            <div style="margin-bottom: 15px">
                                <div style="
                                            display: flex;
                                            align-items: flex-start;
                                            gap: 10px;
                                            margin-bottom: 10px;
                                        ">
                                    <i class="fas fa-lightbulb" style="
                                                color: #ffc107;
                                                margin-top: 3px;
                                            "></i>
                                    <div>
                                        <strong style="color: #2d3748">Better Task Assignment</strong>
                                        <p style="
                                                    color: #718096;
                                                    font-size: 0.85rem;
                                                    margin: 3px 0 0 0;
                                                ">
                                            Skills help managers assign
                                            tasks that match your expertise
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-bottom: 15px">
                                <div style="
                                            display: flex;
                                            align-items: flex-start;
                                            gap: 10px;
                                            margin-bottom: 10px;
                                        ">
                                    <i class="fas fa-chart-line" style="
                                                color: #28a745;
                                                margin-top: 3px;
                                            "></i>
                                    <div>
                                        <strong style="color: #2d3748">Performance Tracking</strong>
                                        <p style="
                                                    color: #718096;
                                                    font-size: 0.85rem;
                                                    margin: 3px 0 0 0;
                                                ">
                                            Track how well your skills align
                                            with completed tasks
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div style="
                                            display: flex;
                                            align-items: flex-start;
                                            gap: 10px;
                                        ">
                                    <i class="fas fa-users" style="
                                                color: #17a2b8;
                                                margin-top: 3px;
                                            "></i>
                                    <div>
                                        <strong style="color: #2d3748">Team Collaboration</strong>
                                        <p style="
                                                    color: #718096;
                                                    font-size: 0.85rem;
                                                    margin: 3px 0 0 0;
                                                ">
                                            Help teammates find expertise
                                            within the team
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('manageSkillsModal')"
                    style="background: #e2e8f0; color: #2d3748">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="closeModal('manageSkillsModal')">
                    <i class="fas fa-save"></i> Save Skills
                </button>
            </div>
        </div>
    </div>

    <div id="addTeamMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-user-plus"></i> Add New Team Member
                </h3>
                <button class="modal-close" onclick="closeModal('addTeamMemberModal')">&times;</button>
            </div>
            <form onsubmit="addTeamMemberToProject(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Username *</label><input type="text" id="addMemberUsername" required
                            placeholder="Enter username" />
                    </div>
                    <div class="form-group">
                        <label>Email *</label><input type="email" id="addMemberEmail" required
                            placeholder="Enter email" />
                    </div>
                    <div class="form-group">
                        <label>Password *</label><input type="password" id="addMemberPassword" required
                            placeholder="Enter password (8+ chars, 2+ special chars)" />
                    </div>
                    <div class="form-group">
                        <label>Confirm Password *</label><input type="password" id="addMemberConfirmPassword" required
                            placeholder="Confirm password" />
                    </div>
                    <div class="form-group">
                        <label>User Type *</label><select id="addMemberUserType" required>
                            <option value="">Select user type</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('addTeamMemberModal')"
                        style="background: #e2e8f0; color: #2d3748">
                        Cancel</button><button type="submit" class="btn btn-primary">
                        Create & Add Member
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Avatar Upload Modal -->
    <div id="avatarUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-image"></i> Upload Profile Picture</h3>
                <button class="modal-close" onclick="closeAvatarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dragDropArea" style="border: 2px dashed #667eea; border-radius: 8px; padding: 40px; text-align: center; margin-bottom: 20px; background: #f7fafc; cursor: pointer; transition: all 0.3s ease;" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDropZone(event)">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #667eea; margin-bottom: 15px; display: block;"></i>
                    <p style="color: #2d3748; font-weight: 600; margin: 10px 0;">Drag and drop your image here</p>
                    <p style="color: #718096; font-size: 0.9rem;">or click to select a file</p>
                </div>
                <input type="file" id="avatarInput" class="avatar-input" accept="image/*"
                    onchange="handleAvatarSelect(event)">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAvatarModal()">Cancel</button>
                <button class="btn btn-primary" onclick="uploadAvatarFile()">Upload</button>
            </div>
        </div>
    </div>


    <!-- Image Cropper Modal -->
    <div id="cropperModal" class="modal">
        <div class="modal-content cropper-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-crop-alt"></i> Crop Your Profile Picture</h3>
                <button onclick="closeCropperModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="cropper-container">
                    <img id="cropperImage" src="/placeholder.svg" alt="Image for cropping">
                </div>
                <div class="cropper-controls">
                    <button class="cropper-control-btn" onclick="rotateCropper(-90)"><i class="fas fa-redo"></i> Rotate Left</button>
                    <button class="cropper-control-btn" onclick="rotateCropper(90)"><i class="fas fa-undo"></i> Rotate Right</button>
                    <button class="cropper-control-btn" onclick="flipCropperX()"><i class="fas fa-arrows-alt-h"></i> Flip H</button>
                    <button class="cropper-control-btn" onclick="flipCropperY()"><i class="fas fa-arrows-alt-v"></i> Flip V</button>
                    <button class="cropper-control-btn" onclick="resetCropper()"><i class="fas fa-undo"></i> Reset</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCropperModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCroppedImage()"><i class="fas fa-check"></i> Save Picture</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + "/api";
        let currentUser = {};
        let userPermissions = {};
        let allEmployees = [];
        let userRoles = [];
        let selectedTeamMembers = [];
        let newTeamMembers = [];
        let projects = [];
        let tasks = [];
        let milestones = [];
        let documents = [];
        let cropper = null;
        let selectedAvatarFile = null;
        let realTimeUpdateInterval = null;
        let realTimeApiAvailable = false; // Track if real-time API is available

        function checkAuthentication() {
            const employeeData = localStorage.getItem("employee_user");
            const token = localStorage.getItem("employee_token");

            if (!employeeData || !token) {
                console.warn("[v0] No authentication found, redirecting to login");
                window.location.href = "/login";
                return false;
            }

            try {
                currentUser = JSON.parse(employeeData);
                userPermissions = currentUser.permissions || {};
                return true;
            } catch (error) {
                console.error("[v0] Invalid employee data, redirecting to login");
                localStorage.removeItem("employee_user");
                localStorage.removeItem("employee_token");
                window.location.href = "/login";
                return false;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (!checkAuthentication()) {
                return;
            }

            updateUserInfo();
            updateHeaderAvatar();
            loadDashboardData();
            loadRecentActivities();
            loadTeamMembers();
            loadUserTypes();
            loadProfileStats();
            loadProfile();
            loadSkills();
            displayPermissions();
            updatePermissionVisibility();

            setupEventListeners();

            // Check if real-time API is available before starting updates
            checkRealTimeApiAvailability();
        });

        function setupEventListeners() {
            const searchInput = document.getElementById("adminSearchInput");
            if (searchInput) {
                searchInput.addEventListener("keyup", performAdminSearch);
            }

            document.addEventListener('click', function (event) {
                const searchContainer = document.querySelector('.search-container');
                if (searchContainer && !searchContainer.contains(event.target)) {
                    hideSearchResults();
                }
            });
        }

        async function checkRealTimeApiAvailability() {
            try {
                const token = localStorage.getItem('employee_token');
                if (!token) return;

                // Try to access the real-time endpoint
                const response = await fetch(`${API_BASE}/employee/projects/realtime`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status !== 404 && response.status !== 500) {
                    realTimeApiAvailable = true;
                    console.log('[v0] Real-time API is available');
                    startEmployeeLiveUpdates();
                } else {
                    console.warn('[v0] Real-time API endpoint not available, using fallback');
                    // Use fallback method
                    updateRealTimeProjectStatusFallback();
                }
            } catch (error) {
                console.warn('[v0] Real-time API check failed, using fallback:', error.message);
                // Use fallback method
                updateRealTimeProjectStatusFallback();
            }
        }

        function startEmployeeLiveUpdates() {
            if (!realTimeApiAvailable) {
                console.log('[v0] Real-time API not available, using fallback updates');
                updateRealTimeProjectStatusFallback();
                return;
            }

            const token = localStorage.getItem('employee_token');
            if (!token) return;

            // Initial load
            updateRealTimeProjectStatus();

            // Clear any existing interval
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
            }

            // Set new interval with error handling
            realTimeUpdateInterval = setInterval(() => {
                updateRealTimeProjectStatus();
            }, 30000); // 30 seconds interval to reduce load
        }

        function updateRealTimeProjectStatus() {
            const token = localStorage.getItem('employee_token');
            if (!token) return;

            fetch(`${API_BASE}/employee/projects/realtime`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(projects => {
                    renderRealTimeProjects(projects);
                    updateProgressElements(projects);
                    updateProjectTimers();
                })
                .catch(error => {
                    console.warn('[v0] Real-time update failed:', error.message);
                    // Switch to fallback mode if real-time API fails
                    realTimeApiAvailable = false;
                    if (realTimeUpdateInterval) {
                        clearInterval(realTimeUpdateInterval);
                    }
                    updateRealTimeProjectStatusFallback();
                });
        }

        function updateRealTimeProjectStatusFallback() {
            console.log('[v0] Using fallback real-time updates');
            
            // Use existing projects data to simulate real-time updates
            if (projects && projects.length > 0) {
                // Clone projects and add some real-time data
                const enhancedProjects = projects.map(project => {
                    // Calculate progress based on tasks if available
                    let progress = project.progress || 0;
                    let completedTasks = 0;
                    let totalTasks = 0;
                    
                    // Try to get task data for this project
                    if (tasks && tasks.length > 0) {
                        const projectTasks = tasks.filter(task => task.project_id === project.id);
                        totalTasks = projectTasks.length;
                        completedTasks = projectTasks.filter(task => task.status === 'Completed').length;
                        if (totalTasks > 0) {
                            progress = Math.round((completedTasks / totalTasks) * 100);
                        }
                    }
                    
                    return {
                        ...project,
                        progress: progress,
                        completed_tasks: completedTasks,
                        total_tasks: totalTasks,
                        completed_milestones: milestones ? milestones.filter(m => m.project_id === project.id && m.status === 'Completed').length : 0,
                        total_milestones: milestones ? milestones.filter(m => m.project_id === project.id).length : 0
                    };
                });
                
                renderRealTimeProjects(enhancedProjects);
                updateProgressElements(enhancedProjects);
                updateProjectTimers();
            }
            
            // Update timers every minute for fallback
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
            }
            realTimeUpdateInterval = setInterval(() => {
                updateProjectTimers();
            }, 60000); // Update timers every minute
        }

        function updateUserInfo() {
            document.getElementById("userName").textContent =
                currentUser.username || "Employee";
            document.getElementById("userRole").textContent =
                currentUser.user_role || "Employee";
            document.getElementById("headerAvatarInitials").textContent = (
                currentUser.username || "E"
            )
                .substring(0, 2)
                .toUpperCase();

            if (document.getElementById("profileName")) {
                document.getElementById("profileName").textContent = currentUser.username || "Employee";
                document.getElementById("profileRole").textContent = currentUser.user_role || "Employee";
                document.getElementById("profileEmail").textContent = currentUser.email || "-";
                document.getElementById("profileDepartment").textContent = currentUser.department ? `Department: ${currentUser.department}` : "-";
                document.getElementById("profilePhone").value = currentUser.phone || "";
                document.getElementById("profileDeptInput").value = currentUser.department || "";
                document.getElementById("profileBio").value = currentUser.bio || "";
            }
        }

        function displayPermissions() {
            const container = document.getElementById("permissionsGrid");
            if (!container) return;

            const modules = {
                Proj: "Projects",
                Proj_team: "Project Team",
                Proj_doc: "Project Documents",
                Proj_Dis_: "Project Discussion",
                task: "Tasks",
            };
            if (
                !userPermissions ||
                Object.keys(userPermissions).length === 0
            ) {
                if (document.getElementById("noPermissions")) {
                    document.getElementById("noPermissions").style.display = "block";
                }
                container.innerHTML = "";
                return;
            }

            if (document.getElementById("noPermissions")) {
                document.getElementById("noPermissions").style.display = "none";
            }

            container.innerHTML = Object.entries(modules)
                .map(([module, label]) => {
                    const actions = userPermissions[module] || {};
                    return `<div class="permission-module"><h5><i class="fas fa-check-circle"></i> ${label}</h5><div class="permission-actions">${[
                        "View",
                        "Add",
                        "Edit",
                        "Delete",
                        "Download",
                    ]
                        .map((action) => {
                            const has = actions[action] || false;
                            return `<span class="permission-badge ${has ? "granted" : "denied"}"><i class="fas fa-${has ? "check" : "times"}"></i> ${action}</span>`;
                        })
                        .join("")}</div></div>`;
                })
                .join("");
        }

        function updatePermissionVisibility() {
            function setElementDisplay(elementId, displayValue) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = displayValue;
                }
            }

            const canViewProjects = userPermissions["Proj"]?.["View"];
            const canCreateProjects = userPermissions["Proj"]?.["Add"];
            setElementDisplay("projectsTabBtn", canViewProjects ? "flex" : "none");
            setElementDisplay("createProjectBtn", canCreateProjects ? "inline-flex" : "none");
            setElementDisplay("quickCreateProject", canCreateProjects ? "inline-flex" : "none");

            const canViewTasks = userPermissions["task"]?.["View"];
            const canCreateTasks = userPermissions["task"]?.["Add"];
            setElementDisplay("tasksTabBtn", canViewTasks ? "flex" : "none");
            setElementDisplay("createTaskBtn", canCreateTasks ? "inline-flex" : "none");
            setElementDisplay("quickCreateTask", canCreateTasks ? "inline-flex" : "none");

            const canViewMilestones = userPermissions["Proj"]?.["View"];
            const canCreateMilestones = userPermissions["Proj"]?.["Add"];
            setElementDisplay("milestonesTabBtn", canViewMilestones ? "flex" : "none");
            setElementDisplay("createMilestoneBtn", canCreateMilestones ? "inline-flex" : "none");
            setElementDisplay("quickCreateMilestone", canCreateMilestones ? "inline-flex" : "none");

            const canViewDocuments = userPermissions["Proj_doc"]?.["View"];
            const canUploadDocuments = userPermissions["Proj_doc"]?.["Add"];
            setElementDisplay("documentsTabBtn", canViewDocuments ? "flex" : "none");
            setElementDisplay("uploadDocumentBtn", canUploadDocuments ? "inline-flex" : "none");
            setElementDisplay("quickUploadDocument", canUploadDocuments ? "inline-flex" : "none");

            setElementDisplay("activitiesTabBtn", "flex");
            setElementDisplay("settingsTabBtn", "flex");
            setElementDisplay("profileTabBtn", "flex");
        }

        function selectTab(tabName, event) {
            document
                .querySelectorAll(".tab-content")
                .forEach((tab) => tab.classList.remove("active"));
            document
                .querySelectorAll(".tab-button")
                .forEach((btn) => btn.classList.remove("active"));

            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add("active");
            }

            if (event && event.target) {
                const tabBtn = event.target.closest(".tab-button");
                if (tabBtn) {
                    tabBtn.classList.add("active");
                } else {
                    const targetBtn = document.querySelector(
                        `[onclick*="${tabName}"].tab-button`,
                    );
                    if (targetBtn) targetBtn.classList.add("active");
                }
            }

            const token = localStorage.getItem("employee_token");
            if (!token) return;

            if (tabName === "settings-tab") {
                loadUserTypes();
            }
            if (tabName === "profile-tab") {
                loadProfile();
                loadProfileStats();
            }
            if (tabName === "permissions-tab") {
                displayPermissions();
            }
        }

        async function loadUserTypes() {
            try {
                const token = localStorage.getItem("employee_token");
                const response = await fetch(`${API_BASE}/usertypes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Failed to load user types:', response.status);
                    return;
                }
                
                const usertypes = await response.json();
                
                if (!Array.isArray(usertypes)) {
                    console.error('Invalid user types response:', usertypes);
                    return;
                }

                userRoles = usertypes;
                const select = document.getElementById("addMemberUserType");
                if (select) {
                    select.innerHTML = '<option value="">Select user type</option>' +
                        usertypes.map(ut => `<option value="${ut.id}">${ut.user_role}</option>`).join('');
                }
                
                const display = document.getElementById("userTypesDisplay");
                if (display) {
                    if (userRoles.length > 0) {
                        display.innerHTML = userRoles.map(role =>
                            `<div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                                <strong>${role.user_role}</strong>
                                <div style="color: #718096; font-size: 0.85rem;">ID: ${role.id}</div>
                            </div>`
                        ).join('');
                    } else {
                        display.innerHTML = '<div class="empty-state" style="padding: 20px"><i class="fas fa-users" style="font-size: 2rem; opacity: 0.5"></i><p style="margin-top: 10px">No custom user types created yet</p></div>';
                    }
                }
            } catch (error) {
                console.error("[v0] Error loading user types:", error);
            }
        }

        async function loadTeamMembers() {
            try {
                const token = localStorage.getItem("employee_token");
                const response = await fetch(`${API_BASE}/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Failed to load team members:', response.status);
                    return;
                }
                
                const users = await response.json();
                
                if (!Array.isArray(users)) {
                    console.error('Invalid users response:', users);
                    return;
                }
                
                allEmployees = users;
                renderTeamMembersList();
            } catch (error) {
                console.error("[v0] Error loading team members:", error);
            }
        }

        function renderTeamMembersList() {
            const container = document.getElementById("teamMembersList");
            if (!container) return;
            container.innerHTML = "";
            const memberList = document.createElement("div");
            memberList.className = "team-member-list";
            allEmployees.forEach((emp) => {
                const checkboxDiv = document.createElement("div");
                checkboxDiv.className = "team-member-checkbox";
                checkboxDiv.innerHTML = `<input type="checkbox" id="member-${emp.id}" value="${emp.id}" onchange="updateTeamMemberSelection()"><div class="team-member-info"><div class="team-member-name">${emp.username}</div><div class="team-member-email">${emp.user_role || "N/A"}</div></div>`;
                memberList.appendChild(checkboxDiv);
            });
            container.appendChild(memberList);
        }

        function updateTeamMemberSelection() {
            selectedTeamMembers = [];
            document
                .querySelectorAll(
                    '.team-member-checkbox input[type="checkbox"]:checked',
                )
                .forEach((checkbox) => {
                    selectedTeamMembers.push(parseInt(checkbox.value));
                });
        }

        async function loadDashboardData() {
            const token = localStorage.getItem("employee_token");
            const headers = { Authorization: `Bearer ${token}` };
            try {
                const [
                    statsRes,
                    projectsRes,
                    tasksRes,
                    milestonesRes,
                    docsRes,
                ] = await Promise.all([
                    fetch(`${API_BASE}/employee/dashboard/stats`, {
                        method: "GET",
                        headers,
                    }),
                    fetch(`${API_BASE}/employee/projects`, {
                        method: "GET",
                        headers,
                    }),
                    fetch(`${API_BASE}/employee/tasks`, {
                        method: "GET",
                        headers,
                    }),
                    fetch(`${API_BASE}/employee/milestones`, {
                        method: "GET",
                        headers,
                    }),
                    fetch(`${API_BASE}/employee/documents`, {
                        method: "GET",
                        headers,
                    }),
                ]);
                if (statsRes.ok) {
                    const stats = await statsRes.json();
                    document.getElementById("statProjects").textContent =
                        stats.total_projects || 0;
                    document.getElementById("statTasks").textContent =
                        stats.total_tasks || 0;
                    document.getElementById("statCompleted").textContent =
                        stats.completed_tasks || 0;
                    document.getElementById("statMilestones").textContent =
                        stats.total_milestones || 0;
                }
                if (projectsRes.ok) {
                    projects = await projectsRes.json();
                    renderProjects(projects);
                    renderRecentProjects(projects);
                    populateProjectDropdowns(projects);
                } else {
                    document.getElementById("noProjects").style.display =
                        "block";
                }
                if (tasksRes.ok) {
                    tasks = await tasksRes.json();
                    renderTasks(tasks);
                }
                if (milestonesRes.ok) {
                    milestones = await milestonesRes.json();
                    renderMilestones(milestones);
                }
                if (docsRes.ok) {
                    documents = await docsRes.json();
                    renderDocuments(documents);
                }
            } catch (error) {
                console.error("[v0] Error loading dashboard data:", error);
                showAlert("Error loading dashboard data", "error");
            }
        }

        async function loadProfileStats() {
            try {
                const token = localStorage.getItem('employee_token');
                const response = await fetch(`${API_BASE}/employee/profile/stats`, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });

                if (response.ok) {
                    const stats = await response.json();

                    document.getElementById('profileStatProjects').textContent = stats.total_projects || 0;
                    document.getElementById('profileStatCompleted').textContent = stats.completed_tasks || 0;
                    document.getElementById('profileStatPending').textContent = stats.pending_tasks || 0;
                    document.getElementById('profileStatMilestones').textContent = stats.total_milestones || 0;

                    document.getElementById('statProjects').textContent = stats.total_projects || 0;
                    document.getElementById('statTasks').textContent = (stats.completed_tasks || 0) + (stats.pending_tasks || 0);
                    document.getElementById('statCompleted').textContent = stats.completed_tasks || 0;
                    document.getElementById('statMilestones').textContent = stats.total_milestones || 0;
                }
            } catch (error) {
                console.error('Error loading profile stats:', error);
            }
        }

        async function loadRecentActivities() {
            const token = localStorage.getItem("employee_token");
            const headers = { Authorization: `Bearer ${token}` };
            try {
                const res = await fetch(`${API_BASE}/employee/activities`, {
                    method: "GET",
                    headers,
                });
                if (res.ok) {
                    const activities = await res.json();
                    renderActivities(activities);
                }
            } catch (error) {
                console.error("[v0] Error loading activities:", error);
            }
        }

        function renderActivities(activities) {
            const container = document.getElementById("activitiesList");
            const noActivity = document.getElementById("noActivities");
            if (!activities || activities.length === 0) {
                if (container) container.innerHTML = "";
                if (noActivity) noActivity.style.display = "block";
                return;
            }
            if (noActivity) noActivity.style.display = "none";
            if (!container) return;
            container.innerHTML = activities
                .map((activity) => {
                    let content = `<div class="item-card"><div class="item-content"><h5><i class="fas fa-history"></i> ${activity.description}</h5><p><strong>Activity:</strong> ${activity.activity_type.replace(/_/g, " ").toUpperCase()}</p>`;
                    if (
                        activity.activity_type === "project_created" &&
                        activity.project_title
                    ) {
                        content += `<div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;"><h6 style="color: #2d3748; margin-bottom: 10px;"><i class="fas fa-project-diagram"></i> Project Details</h6><p><strong>Title:</strong> ${activity.project_title}</p>${activity.project_description ? `<p><strong>Description:</strong> ${activity.project_description}</p>` : ""}${activity.project_deadline ? `<p><strong>Deadline:</strong> ${new Date(activity.project_deadline).toLocaleDateString()}</p>` : ""}</div>`;
                    }
                    content += `<div class="item-meta"><span><i class="fas fa-user"></i> ${activity.username || "Unknown"}</span><span><i class="fas fa-calendar"></i> ${new Date(activity.created_at).toLocaleDateString()}</span></div></div></div>`;
                    return content;
                })
                .join("");
        }

        function renderProjects(projects) {
            const container = document.getElementById("projectsList");
            if (!container) return;

            container.innerHTML = "";
            if (projects.length === 0) {
                document.getElementById("noProjects").style.display =
                    "block";
                return;
            }
            document.getElementById("noProjects").style.display = "none";
            projects.forEach((project) => {
                const card = document.createElement("div");
                card.className = "item-card";
                const statusBadge =
                    project.status === "Completed"
                        ? "badge-success"
                        : project.status === "In Progress"
                            ? "badge-info"
                            : "badge-warning";
                const isCompleted = project.status === "Completed";
                card.innerHTML = `<div class="item-content"><h5>${project.title}</h5><p>${project.description || "No description"}</p><div class="item-meta"><span><i class="fas fa-user"></i> ${project.creator_name || "Unknown"}</span><span><i class="fas fa-calendar"></i> ${new Date(project.created_at).toLocaleDateString()}</span><span class="badge ${statusBadge}">${project.status}</span></div></div><div class="item-actions">${!isCompleted ? `<button class="btn btn-success btn-sm" onclick="completeProject(${project.id})"><i class="fas fa-check"></i> Complete</button>` : `<span style="color: #48bb78; font-weight: 600"><i class="fas fa-check-circle"></i> Completed</span>`}</div>`;
                container.appendChild(card);
            });
        }

        function renderRecentProjects(projects) {
            const container = document.getElementById("recentActivity");
            const noActivity = document.getElementById("noActivity");
            if (!projects || projects.length === 0) {
                if (container) container.innerHTML = "";
                if (noActivity) noActivity.style.display = "block";
                return;
            }
            if (noActivity) noActivity.style.display = "none";
            if (!container) return;
            container.innerHTML = projects
                .slice(0, 3)
                .map(
                    (project) =>
                        `<div class="item-card"><div class="item-content"><h5>${project.title}</h5><p>${project.description || "No description"}</p><div class="item-meta"><span><i class="fas fa-user"></i> ${project.creator_name || "Unknown"}</span><span><i class="fas fa-calendar"></i> ${new Date(project.created_at).toLocaleDateString()}</span></div></div></div>`,
                )
                .join("");
        }

        function renderTasks(tasks) {
            const container = document.getElementById("tasksList");
            if (!container) return;

            container.innerHTML = "";
            if (tasks.length === 0) {
                document.getElementById("noTasks").style.display = "block";
                return;
            }
            document.getElementById("noTasks").style.display = "none";
            tasks.forEach((task) => {
                const card = document.createElement("div");
                card.className = "item-card";
                const statusBadge =
                    task.status === "Completed"
                        ? "badge-success"
                        : task.status === "In Progress"
                            ? "badge-info"
                            : "badge-warning";
                const priorityBadge =
                    task.priority === "High"
                        ? "badge-danger"
                        : task.priority === "Medium"
                            ? "badge-warning"
                            : "badge-info";
                card.innerHTML = `<div class="item-content"><h5>${task.title}</h5><p>${task.description || "No description"}</p><div class="item-meta"><span><i class="fas fa-folder"></i> ${task.project_name || "No Project"}</span><span class="badge ${statusBadge}">${task.status}</span><span class="badge ${priorityBadge}">${task.priority}</span></div></div><div class="item-actions"><button class="btn btn-success btn-sm" onclick="completeTask(${task.id})" ${userPermissions["task"]?.["Edit"] ? "" : "disabled"}><i class="fas fa-check"></i> Complete</button></div>`;
                container.appendChild(card);
            });
        }

        function renderMilestones(milestones) {
            const container = document.getElementById("milestonesList");
            if (!container) return;

            container.innerHTML = "";
            if (milestones.length === 0) {
                document.getElementById("noMilestones").style.display =
                    "block";
                return;
            }
            document.getElementById("noMilestones").style.display = "none";
            milestones.forEach((milestone) => {
                const card = document.createElement("div");
                card.className = "item-card";
                const statusBadge =
                    milestone.status === "Completed"
                        ? "badge-success"
                        : "badge-warning";
                card.innerHTML = `<div class="item-content"><h5>${milestone.title}</h5><p>${milestone.description || "No description"}</p><div class="item-meta"><span><i class="fas fa-folder"></i> ${milestone.project_title || "No Project"}</span><span><i class="fas fa-calendar"></i> ${milestone.due_date ? new Date(milestone.due_date).toLocaleDateString() : "No deadline"}</span><span class="badge ${statusBadge}">${milestone.status}</span></div></div><div class="item-actions"><button class="btn btn-success btn-sm" onclick="completeMilestone(${milestone.id})" ${userPermissions["Proj"]?.["Edit"] ? "" : "disabled"}><i class="fas fa-check"></i> Complete</button></div>`;
                container.appendChild(card);
            });
        }

        function renderDocuments(docs) {
            const container = document.getElementById("documentsList");
            if (!container) return;

            container.innerHTML = "";
            if (docs.length === 0) {
                document.getElementById("noDocuments").style.display = "block";
                return;
            }
            document.getElementById("noDocuments").style.display = "none";
            
            docs.forEach((doc) => {
                const card = document.createElement("div");
                card.className = "item-card";
                
                const canDownload = userPermissions["Proj_doc"]?.["Download"] === true;
                const canDelete = userPermissions["Proj_doc"]?.["Delete"] === true;
                
                card.innerHTML = `
                    <div class="item-content">
                        <h5><i class="fas fa-file"></i> ${doc.original_filename}</h5>
                        <div class="item-meta">
                            <span><i class="fas fa-user"></i> ${doc.uploaded_by || "Unknown"}</span>
                            <span><i class="fas fa-calendar"></i> ${new Date(doc.uploaded_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-secondary btn-sm download-doc-btn" data-doc-id="${doc.id}" ${!canDownload ? "disabled title='You do not have permission to download documents'" : "title='Download document'"}><i class="fas fa-download"></i> Download</button>
                        <button class="btn btn-danger btn-sm delete-doc-btn" data-doc-id="${doc.id}" ${!canDelete ? "disabled title='You do not have permission to delete documents'" : "title='Delete document'"}><i class="fas fa-trash"></i> Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            setupDocumentButtonListeners();
        }

        function setupDocumentButtonListeners() {
            const container = document.getElementById("documentsList");
            if (!container) return;

            container.addEventListener("click", (e) => {
                if (e.target.closest(".download-doc-btn")) {
                    const btn = e.target.closest(".download-doc-btn");
                    if (btn.disabled) {
                        console.log("[v0] Download button is disabled due to insufficient permissions");
                        showAlert("You do not have permission to download documents.", "error");
                        return;
                    }
                    const docId = parseInt(btn.getAttribute("data-doc-id"), 10);
                    if (!isNaN(docId)) {
                        downloadDocument(docId);
                    }
                }
            });

            container.addEventListener("click", (e) => {
                if (e.target.closest(".delete-doc-btn")) {
                    const btn = e.target.closest(".delete-doc-btn");
                    if (btn.disabled) {
                        console.log("[v0] Delete button is disabled due to insufficient permissions");
                        showAlert("You do not have permission to delete documents.", "error");
                        return;
                    }
                    const docId = parseInt(btn.getAttribute("data-doc-id"), 10);
                    if (!isNaN(docId)) {
                        deleteDocument(docId);
                    }
                }
            });
        }

        function populateProjectDropdowns(projects) {
            const selects = [
                document.getElementById("taskProject"),
                document.getElementById("milestoneProject"),
                document.getElementById("documentProject"),
            ];
            selects.forEach((select) => {
                if (select) {
                    select.innerHTML =
                        '<option value="">Select a project</option>' +
                        projects
                            .map(
                                (p) =>
                                    `<option value="${p.id}">${p.title}</option>`,
                            )
                            .join("");
                }
            });
            const assigneeSelect = document.getElementById("taskAssignee");
            if (assigneeSelect) {
                assigneeSelect.innerHTML =
                    '<option value="">Unassigned</option>' +
                    allEmployees
                        .map(
                            (e) =>
                                `<option value="${e.id}">${e.username}</option>`,
                        )
                        .join("");
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove("active");
            }
            if (modalId === "createProjectModal") {
                newTeamMembers = [];
                const display = document.getElementById(
                    "newTeamMembersDisplay",
                );
                if (display) display.style.display = "none";
            }
        }

        function openCreateProjectModal() {
            if (
                !userPermissions["Proj"] ||
                !userPermissions["Proj"]["Add"]
            ) {
                showAlert(
                    "You do not have permission to create projects",
                    "error",
                );
                return;
            }
            newTeamMembers = [];
            selectedTeamMembers = [];
            const display = document.getElementById(
                "newTeamMembersDisplay",
            );
            if (display) display.style.display = "none";
            document
                .querySelectorAll(
                    '.team-member-checkbox input[type="checkbox"]',
                )
                .forEach((checkbox) => {
                    checkbox.checked = false;
                });
            const modal = document.getElementById("createProjectModal");
            if (modal) modal.classList.add("active");
        }

        function openCreateTaskModal() {
            document
                .getElementById("createTaskModal")
                .classList.add("active");
        }
        function openCreateMilestoneModal() {
            document
                .getElementById("createMilestoneModal")
                .classList.add("active");
        }
        function openUploadDocumentModal() {
            document
                .getElementById("uploadDocumentModal")
                .classList.add("active");
        }

        function openAddTeamMemberModal() {
            const modal = document.getElementById("addTeamMemberModal");
            const select = document.getElementById("addMemberUserType");
            if (select) {
                select.innerHTML =
                    '<option value="">Select user type</option>' +
                    userRoles
                        .map(
                            (role) =>
                                `<option value="${role.id}">${role.user_role}</option>`,
                        )
                        .join("");
            }
            if (modal) modal.classList.add("active");
        }

        async function addTeamMemberToProject(event) {
            event.preventDefault();
            const username = document
                .getElementById("addMemberUsername")
                .value.trim();
            const email = document
                .getElementById("addMemberEmail")
                .value.trim();
            const password =
                document.getElementById("addMemberPassword").value;
            const confirmPassword = document.getElementById(
                "addMemberConfirmPassword",
            ).value;
            const userTypeId =
                document.getElementById("addMemberUserType").value;

            if (
                !username ||
                !email ||
                !password ||
                !confirmPassword ||
                !userTypeId
            ) {
                showAlert("All fields are required", "error");
                return;
            }

            if (
                !/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)
            ) {
                showAlert("Invalid email format", "error");
                return;
            }

            if (password !== confirmPassword) {
                showAlert("Passwords do not match", "error");
                return;
            }

            if (password.length < 8) {
                showAlert(
                    "Password must be at least 8 characters",
                    "error",
                );
                return;
            }

            const specialChars = (password.match(/[!@#$%^&*]/g) || [])
                .length;
            if (specialChars < 2) {
                showAlert(
                    "Password must contain at least 2 special characters (!@#$%^&*)",
                    "error",
                );
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${localStorage.getItem("employee_token")}`,
                    },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        confirm_password: confirmPassword,
                        user_type_id: parseInt(userTypeId),
                    }),
                });

                const data = await response.json();
                if (!response.ok) {
                    showAlert(
                        data.error || "Failed to create team member",
                        "error",
                    );
                    return;
                }

                const newMember = data;
                selectedTeamMembers.push(newMember.id);
                await loadTeamMembers();
                showAlert("Team member created successfully!", "success");
                closeModal("addTeamMemberModal");
                document.getElementById("addMemberUsername").value = "";
                document.getElementById("addMemberEmail").value = "";
                document.getElementById("addMemberPassword").value = "";
                document.getElementById("addMemberConfirmPassword").value =
                    "";
                document.getElementById("addMemberUserType").value = "";
            } catch (error) {
                console.error("Error adding team member:", error);
                showAlert("Error creating team member", "error");
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById("alertContainer");
            const alertDiv = document.createElement("div");
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `${message}<button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:inherit">&times;</button>`;
            container.appendChild(alertDiv);
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        async function createProject(event) {
            event.preventDefault();

            const title = document.getElementById('projectTitle').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            const deadline = document.getElementById('projectDeadline').value;
            const reportingTime = document.getElementById('projectReportingTime').value;

            if (!title || !deadline || !reportingTime) {
                showAlert('Project title, deadline, and reporting time are required', 'error');
                return;
            }

            const statusDiv = document.getElementById('newProjectStatus');
            const statusMsg = document.getElementById('statusMessage');
            statusDiv.style.display = 'block';
            statusMsg.textContent = 'Creating project...';

            try {
                const token = localStorage.getItem('employee_token');
                const response = await fetch(`${API_BASE}/employee/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        deadline,
                        reporting_time: reportingTime,
                        team_members: selectedTeamMembers
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    statusMsg.textContent = 'Failed to create project';
                    statusDiv.className = 'alert alert-error';
                    setTimeout(() => statusDiv.style.display = 'none', 3000);
                    showAlert(data.error || 'Failed to create project', 'error');
                    return;
                }

                statusMsg.textContent = 'Project created successfully!';
                statusDiv.className = 'alert alert-success';

                setTimeout(() => {
                    closeModal('createProjectModal');
                    statusDiv.style.display = 'none';
                    statusDiv.className = 'alert alert-info';

                    document.getElementById('projectTitle').value = '';
                    document.getElementById('projectDescription').value = '';
                    document.getElementById('projectDeadline').value = '';
                    document.getElementById('projectReportingTime').value = '09:00';

                    loadDashboardData();
                    updateRealTimeProjectStatus();

                    showAlert('Project created successfully!', 'success');
                }, 1500);

            } catch (error) {
                statusMsg.textContent = 'Error creating project';
                statusDiv.className = 'alert alert-error';
                setTimeout(() => statusDiv.style.display = 'none', 3000);
                showAlert('Error creating project', 'error');
            }
        }

        async function createTask(event) {
            event.preventDefault();
            const title = document.getElementById("taskTitle").value.trim();
            const description = document
                .getElementById("taskDescription")
                .value.trim();
            const projectId = document.getElementById("taskProject").value;
            const assigneeId =
                document.getElementById("taskAssignee").value;
            const priority = document.getElementById("taskPriority").value;
            const deadline = document.getElementById("taskDeadline").value;
            if (!title || !projectId) {
                showAlert("Task title and project are required", "error");
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/employee/tasks`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${localStorage.getItem("employee_token")}`,
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        project_id: parseInt(projectId),
                        assigned_to_id: assigneeId
                            ? parseInt(assigneeId)
                            : null,
                        priority,
                        deadline: deadline || null,
                    }),
                });
                const data = await response.json();
                if (!response.ok) {
                    showAlert(
                        data.error || "Failed to create task",
                        "error",
                    );
                    return;
                }
                showAlert("Task created successfully!", "success");
                closeModal("createTaskModal");
                loadDashboardData();
            } catch (error) {
                showAlert("Error creating task", "error");
            }
        }

        async function createMilestone(event) {
            event.preventDefault();
            const title = document
                .getElementById("milestoneTitle")
                .value.trim();
            const description = document
                .getElementById("milestoneDescription")
                .value.trim();
            const projectId =
                document.getElementById("milestoneProject").value;
            const dueDate =
                document.getElementById("milestoneDueDate").value;
            if (!title || !projectId) {
                showAlert(
                    "Milestone title and project are required",
                    "error",
                );
                return;
            }
            try {
                const response = await fetch(
                    `${API_BASE}/employee/milestones`,
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${localStorage.getItem("employee_token")}`,
                        },
                        body: JSON.stringify({
                            title,
                            description,
                            project_id: parseInt(projectId),
                            due_date: dueDate || null,
                        }),
                    },
                );
                const data = await response.json();
                if (!response.ok) {
                    showAlert(
                        data.error || "Failed to create milestone",
                        "error",
                    );
                    return;
                }
                showAlert("Milestone created successfully!", "success");
                closeModal("createMilestoneModal");
                loadDashboardData();
            } catch (error) {
                showAlert("Error creating milestone", "error");
            }
        }

        async function uploadDocument(event) {
            event.preventDefault();
            const fileInput = document.getElementById("documentFile");
            const projectId =
                document.getElementById("documentProject").value;
            if (!fileInput.files[0] || !projectId) {
                showAlert("File and project are required", "error");
                return;
            }
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("project_id", projectId);
            try {
                const response = await fetch(
                    `${API_BASE}/employee/documents/upload`,
                    {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${localStorage.getItem("employee_token")}`,
                        },
                        body: formData,
                    },
                );
                const data = await response.json();
                if (!response.ok) {
                    showAlert(
                        data.error || "Failed to upload document",
                        "error",
                    );
                    return;
                }
                showAlert("Document uploaded successfully!", "success");
                closeModal("uploadDocumentModal");
                loadDashboardData();
            } catch (error) {
                showAlert("Error uploading document", "error");
            }
        }

        async function downloadDocument(docId) {
            if (!docId) {
                console.error("[v0] downloadDocument: docId is missing");
                showAlert("Invalid document ID. Please refresh and try again.", "error");
                return;
            }

            const numId = parseInt(docId, 10);
            if (isNaN(numId) || numId <= 0) {
                console.error("[v0] downloadDocument: Invalid docId - not a valid positive number", docId);
                showAlert("Invalid document ID. Please refresh and try again.", "error");
                return;
            }
            docId = numId;

            if (!confirm("Download this document?")) {
                console.log("[v0] Download cancelled by user");
                return;
            }

            try {
                const token = localStorage.getItem("employee_token");
                if (!token) {
                    console.error("[v0] downloadDocument: No authentication token found");
                    showAlert("Authentication required. Please log in.", "error");
                    return;
                }

                console.log("[v0] Starting document download for ID:", docId);
                
                const response = await fetch(`${API_BASE}/employee/documents/${docId}/download`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });

                console.log("[v0] Download response status:", response.status);

                if (!response.ok) {
                    let errorMessage = "Failed to download document";
                    
                    if (response.status === 404) {
                        errorMessage = "Document not found. It may have been deleted.";
                    } else if (response.status === 403) {
                        errorMessage = "You don't have permission to download this document.";
                    } else if (response.status === 401) {
                        errorMessage = "Your session has expired. Please log in again.";
                    } else if (response.status === 500) {
                        errorMessage = "Server error. Please try again later.";
                    } else {
                        errorMessage = `Failed to download document (HTTP ${response.status})`;
                    }
                    
                    console.error("[v0] Download failed:", errorMessage, response.status);
                    showAlert(errorMessage, "error");
                    return;
                }

                const contentType = response.headers.get("content-type");
                console.log("[v0] Content-Type header:", contentType);
                
                if (contentType && contentType.includes("application/json")) {
                    console.error("[v0] Received JSON response instead of file - likely an error response");
                    try {
                        const errorData = await response.json();
                        showAlert(errorData.error || "Failed to download document", "error");
                    } catch (e) {
                        showAlert("Failed to download document", "error");
                    }
                    return;
                }

                const blob = await response.blob();
                console.log("[v0] Blob received - size:", blob.size, "bytes, type:", blob.type);

                if (blob.size === 0) {
                    console.error("[v0] Received empty blob - document may be corrupted");
                    showAlert("Downloaded file is empty. Document may be corrupted.", "error");
                    return;
                }

                let filename = "document";
                const contentDisposition = response.headers.get("content-disposition");
                
                if (contentDisposition) {
                    console.log("[v0] Content-Disposition header:", contentDisposition);
                    
                    let matches = contentDisposition.match(/filename\*=(?:UTF-8'')?(.+?)(?:;|$)/);
                    if (matches && matches[1]) {
                        try {
                            filename = decodeURIComponent(matches[1]);
                            console.log("[v0] Extracted filename (RFC 5987):", filename);
                        } catch (e) {
                            console.warn("[v0] Failed to decode RFC 5987 filename, trying fallback");
                        }
                    }
                    
                    if (filename === "document") {
                        matches = contentDisposition.match(/filename="?([^";]+)"?/);
                        if (matches && matches[1]) {
                            filename = matches[1];
                            console.log("[v0] Extracted filename (simple):", filename);
                        }
                    }
                }

                console.log("[v0] Final filename for download:", filename);

                const url = window.URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = filename;
                
                document.body.appendChild(link);
                console.log("[v0] Triggering download for file:", filename);
                
                link.click();
                
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                console.log("[v0] Document download completed successfully");
                showAlert(`Document "${filename}" downloaded successfully!`, "success");

            } catch (error) {
                console.error("[v0] Download document error:", error.message, error.stack);
                showAlert(`Error downloading document: ${error.message}`, "error");
            }
        }

        async function deleteDocument(docId) {
            if (!docId) {
                console.error("[v0] deleteDocument: docId is missing");
                showAlert("Invalid document ID. Please refresh and try again.", "error");
                return;
            }

            const numId = parseInt(docId, 10);
            if (isNaN(numId) || numId <= 0) {
                console.error("[v0] deleteDocument: Invalid docId - not a valid positive number", docId);
                showAlert("Invalid document ID. Please refresh and try again.", "error");
                return;
            }
            docId = numId;

            if (!confirm("Are you sure you want to delete this document? This action cannot be undone.")) {
                console.log("[v0] Delete cancelled by user");
                return;
            }

            try {
                const token = localStorage.getItem("employee_token");
                if (!token) {
                    console.error("[v0] deleteDocument: No authentication token found");
                    showAlert("Authentication required. Please log in.", "error");
                    return;
                }

                console.log("[v0] Deleting document with ID:", docId);
                
                const deleteBtn = document.querySelector(`button[data-doc-id="${docId}"].delete-doc-btn`);
                if (deleteBtn) {
                    deleteBtn.disabled = true;
                    deleteBtn.style.opacity = "0.5";
                    deleteBtn.style.cursor = "not-allowed";
                    console.log("[v0] Delete button disabled to prevent duplicate requests");
                }

                const response = await fetch(`${API_BASE}/employee/documents/${docId}/delete`, {
                    method: "DELETE",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                console.log("[v0] Delete response status:", response.status);
                
                if (response.ok) {
                    try {
                        const data = await response.json();
                        console.log("[v0] Document deleted successfully:", data);
                    } catch (e) {
                        console.warn("[v0] Could not parse success response body");
                    }
                    
                    showAlert("Document deleted successfully!", "success");
                    
                    console.log("[v0] Waiting 500ms before reloading documents...");
                    setTimeout(() => {
                        console.log("[v0] Reloading dashboard data after delete");
                        if (typeof loadDashboardData === 'function') {
                            loadDashboardData();
                        } else {
                            console.error("[v0] loadDashboardData function not available");
                            location.reload();
                        }
                    }, 500);
                } else {
                    let errorMessage = "Failed to delete document";
                    
                    if (response.status === 404) {
                        errorMessage = "Document not found. It may have already been deleted.";
                    } else if (response.status === 403) {
                        errorMessage = "You don't have permission to delete this document.";
                    } else if (response.status === 401) {
                        errorMessage = "Your session has expired. Please log in again.";
                    } else if (response.status === 500) {
                        errorMessage = "Server error. Please try again later.";
                    }
                    
                    try {
                        const errorData = await response.json();
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (e) {
                        console.warn("[v0] Could not parse error response body");
                    }
                    
                    console.error("[v0] Delete failed:", errorMessage, response.status);
                    showAlert(errorMessage, "error");
                    
                    if (deleteBtn) {
                        deleteBtn.disabled = false;
                        deleteBtn.style.opacity = "1";
                        deleteBtn.style.cursor = "pointer";
                        console.log("[v0] Delete button re-enabled after error");
                    }
                }
            } catch (error) {
                console.error("[v0] Delete document error:", error.message, error.stack);
                showAlert(`Error deleting document: ${error.message}`, "error");
                
                const deleteBtn = document.querySelector(`button[data-doc-id="${docId}"].delete-doc-btn`);
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.style.opacity = "1";
                    deleteBtn.style.cursor = "pointer";
                    console.log("[v0] Delete button re-enabled after exception");
                }
            }
        }

        function openManageSkillsModal() {
            const token = localStorage.getItem("employee_token");
            if (!token) {
                showAlert("Please log in first", "error");
                return;
            }
            document
                .getElementById("manageSkillsModal")
                .classList.add("active");
            loadSkills();
        }

        async function loadSkills() {
            const token = localStorage.getItem("employee_token");
            if (!token) return;

            try {
                const response = await fetch(
                    `${API_BASE}/employee/skills`,
                    {
                        method: "GET",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json",
                        },
                    },
                );

                if (response.ok) {
                    const skills = await response.json();
                    renderSkills(skills);
                    updateProfileSkills(skills);
                }
            } catch (error) {
                console.error("Error loading skills:", error);
            }
        }

        function updateProfileSkills(skills) {
            const profileSkillsList = document.getElementById("profileSkillsList");
            if (!profileSkillsList) return;

            if (!skills || skills.length === 0) {
                profileSkillsList.innerHTML = '<span style="color: #718096">No skills added yet</span>';
                return;
            }

            profileSkillsList.innerHTML = skills
                .map(skill => `<span class="badge" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">${skill.skill_name}</span>`)
                .join('');
        }

        function renderSkills(skills) {
            const container = document.getElementById("currentSkillsList");
            if (!container) return;

            if (!skills || skills.length === 0) {
                container.innerHTML = `
                        <div class="empty-state" style="padding: 30px">
                            <i class="fas fa-star" style="font-size: 2rem; color: #ffc107; opacity: 0.5"></i>
                            <p style="margin-top: 10px; color: #718096">No skills added yet. Add your first skill above!</p>
                        </div>
                    `;
                return;
            }

            container.innerHTML = `
                    <div style="display: flex; flex-wrap: wrap; gap: 10px">
                        ${skills
                    .map(
                        (skill) => `
                            <div class="badge" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 15px; display: flex; align-items: center; gap: 8px">
                                <span>${skill.skill_name}</span>
                                <button onclick="deleteSkill(${skill.id})" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 0.9rem">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `,
                    )
                    .join("")}
                    </div>
                `;
        }

        async function addSkill() {
            const token = localStorage.getItem("employee_token");
            if (!token) {
                showAlert("Please log in first", "error");
                return;
            }

            const input = document.getElementById("newSkillInput");
            const skillName = input.value.trim();

            if (!skillName) {
                showAlert("Please enter a skill name", "error");
                return;
            }

            try {
                const response = await fetch(
                    `${API_BASE}/employee/skills`,
                    {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ skill_name: skillName }),
                    },
                );

                const data = await response.json();

                if (response.ok) {
                    input.value = "";
                    showAlert("Skill added successfully!", "success");
                    loadSkills();
                    loadProfile();
                } else {
                    showAlert(data.error || "Failed to add skill", "error");
                }
            } catch (error) {
                showAlert("Error adding skill", "error");
            }
        }

        async function deleteSkill(skillId) {
            const token = localStorage.getItem("employee_token");
            if (!token) {
                showAlert("Please log in first", "error");
                return;
            }

            try {
                const response = await fetch(
                    `${API_BASE}/employee/skills/${skillId}`,
                    {
                        method: "DELETE",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json",
                        },
                    },
                );

                if (response.ok) {
                    showAlert("Skill deleted!", "success");
                    loadSkills();
                    loadProfile();
                } else {
                    showAlert("Failed to delete skill", "error");
                }
            } catch (error) {
                showAlert("Error deleting skill", "error");
            }
        }

        async function loadProfile() {
            try {
                const token = localStorage.getItem('employee_token');
                if (!token) {
                    return;
                }

                const response = await fetch(`${API_BASE}/employee/profile`, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });

                if (!response.ok) throw new Error('Failed to load profile');

                const profile = await response.json();
                currentUser = { ...currentUser, ...profile };

                localStorage.setItem('employee_user', JSON.stringify(currentUser));

                document.getElementById('profileName').textContent = profile.username || 'Unknown';
                document.getElementById('profileRole').textContent = profile.user_role || 'Employee';
                document.getElementById('profileEmail').textContent = profile.email || '-';
                document.getElementById('profileDepartment').textContent = profile.department
                    ? `Department: ${profile.department}`
                    : '';

                document.getElementById('profilePhone').value = profile.phone || '';
                document.getElementById('profileDeptInput').value = profile.department || '';
                document.getElementById('profileBio').value = profile.bio || '';

                updateProfileAvatar(profile);
                updateHeaderAvatar();

                const skillsResponse = await fetch(`${API_BASE}/employee/skills`, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });

                if (skillsResponse.ok) {
                    const skills = await skillsResponse.json();
                    updateProfileSkills(skills);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showAlert('Failed to load profile', 'error');
            }
        }

        function updateProfileAvatar(profile) {
            const avatarDiv = document.getElementById('profileAvatar');
            const avatarImg = document.getElementById('profileAvatarImg');

            if (profile.avatar_url) {
                avatarImg.src = profile.avatar_url;
                avatarImg.style.display = 'block';
                avatarDiv.style.display = 'none';
            } else {
                const initials = profile.username ? profile.username.substring(0, 2).toUpperCase() : 'ED';
                avatarDiv.textContent = initials;
                avatarDiv.style.display = 'flex';
                avatarImg.style.display = 'none';
            }
        }

        function updateHeaderAvatar() {
            const headerAvatarImg = document.getElementById('headerAvatarImg');
            const headerAvatarInitials = document.getElementById('headerAvatarInitials');

            if (currentUser.avatar_url) {
                headerAvatarImg.src = currentUser.avatar_url;
                headerAvatarImg.style.display = 'block';
                headerAvatarInitials.style.display = 'none';
            } else {
                const initials = currentUser.username ? currentUser.username.substring(0, 2).toUpperCase() : 'ED';
                headerAvatarInitials.textContent = initials;
                headerAvatarInitials.style.display = 'flex';
                headerAvatarImg.style.display = 'none';
            }

            document.getElementById('userName').textContent = currentUser.username || 'Employee';
            document.getElementById('userRole').textContent = currentUser.user_role || 'Employee';
        }

        function triggerAvatarInput() {
            document.getElementById('avatarInput').click();
        }

        function handleAvatarSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showAlert('Please select a valid image file', 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showAlert('Image size must be less than 5MB', 'error');
                return;
            }

            selectedAvatarFile = file;
            openCropperModal(file);
        }

        function openCropperModal(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const cropperImage = document.getElementById('cropperImage');
                cropperImage.src = e.target.result;

                setTimeout(() => {
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(cropperImage, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 1,
                        responsive: true,
                        restore: true,
                        guides: true,
                        center: true,
                        highlight: true,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: true
                    });
                    document.getElementById('cropperModal').classList.add('active');
                }, 100);
            };
            reader.readAsDataURL(file);
        }

        function rotateCropper(degree) {
            if (cropper) cropper.rotate(degree);
        }

        function flipCropperX() {
            if (cropper) cropper.scaleX(-(cropper.getData().scaleX || -1));
        }

        function flipCropperY() {
            if (cropper) cropper.scaleY(-(cropper.getData().scaleY || -1));
        }

        function resetCropper() {
            if (cropper) cropper.reset();
        }

        function closeCropperModal() {
            document.getElementById('cropperModal').classList.remove('active');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            document.getElementById('avatarInput').value = '';
            selectedAvatarFile = null;
        }

        async function saveCroppedImage() {
            if (!cropper || !selectedAvatarFile) {
                showAlert('Please crop an image first', 'error');
                return;
            }

            try {
                const canvas = cropper.getCroppedCanvas({
                    width: 400,
                    height: 400,
                    fillColor: '#fff',
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high'
                });

                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('avatar', blob, 'profile-picture.png');

                    try {
                        const token = localStorage.getItem('employee_token');
                        const response = await fetch(`${API_BASE}/employee/profile/upload-avatar`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` },
                            body: formData
                        });

                        if (response.ok) {
                            const data = await response.json();
                            showAlert('Profile picture updated successfully!', 'success');
                            closeCropperModal();

                            currentUser.avatar_url = data.avatar_url;
                            localStorage.setItem('employee_user', JSON.stringify(currentUser));

                            loadProfile();
                            updateHeaderAvatar();
                        } else {
                            const error = await response.json();
                            showAlert(error.error || 'Failed to upload image', 'error');
                        }
                    } catch (error) {
                        console.error('[v0] Upload error:', error);
                        showAlert('Failed to upload image', 'error');
                    }
                }, 'image/png', 0.95);
            } catch (error) {
                console.error('[v0] Cropper error:', error);
                showAlert('Failed to process image', 'error');
            }
        }

        async function deleteProfilePicture() {
            if (!confirm('Are you sure you want to remove your profile picture?')) return;

            try {
                const token = localStorage.getItem('employee_token');
                const response = await fetch(`${API_BASE}/employee/profile/avatar`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('Profile picture removed', 'success');
                    currentUser.avatar_url = null;
                    localStorage.setItem('employee_user', JSON.stringify(currentUser));
                    loadProfile();
                    updateHeaderAvatar();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to delete picture', 'error');
                }
            } catch (error) {
                console.error('[v0] Delete error:', error);
                showAlert('Failed to delete picture', 'error');
            }
        }

        async function updateProfile(event) {
            event.preventDefault();

            const phone = document.getElementById('profilePhone').value;
            const department = document.getElementById('profileDeptInput').value;
            const bio = document.getElementById('profileBio').value;

            try {
                const token = localStorage.getItem('employee_token');
                const response = await fetch(`${API_BASE}/employee/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone,
                        department,
                        bio
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showAlert('Profile updated successfully!', 'success');

                    currentUser.phone = phone;
                    currentUser.department = department;
                    currentUser.bio = bio;
                    localStorage.setItem('employee_user', JSON.stringify(currentUser));

                    updateUserInfo();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showAlert('Failed to update profile', 'error');
            }
        }

        function logout() {
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
            }
            localStorage.removeItem('employee_token');
            localStorage.removeItem('employee_user');
            window.location.href = '/login';
        }

        async function performAdminSearch(event) {
            const query = event.target.value.trim();
            const searchResultsDiv = document.getElementById("searchResults");

            if (query.length >= 2) {
                try {
                    const token = localStorage.getItem("employee_token");
                    const response = await fetch(
                        `${API_BASE}/search?q=${encodeURIComponent(query)}`,
                        {
                            method: "GET",
                            headers: {
                                Authorization: `Bearer ${token}`,
                                "Content-Type": "application/json",
                            },
                        },
                    );

                    if (response.ok) {
                        const data = await response.json();
                        displaySearchResults(data.results || []);
                    } else {
                        console.error("Search failed");
                        searchResultsDiv.innerHTML = '<div class="search-result-item">Error searching</div>';
                        searchResultsDiv.style.display = "block";
                    }
                } catch (error) {
                    console.error("Search error:", error);
                    searchResultsDiv.innerHTML = '<div class="search-result-item">Error searching</div>';
                    searchResultsDiv.style.display = "block";
                }
            } else {
                hideSearchResults();
            }
        }

        function displaySearchResults(results) {
            const searchContainer = document.querySelector(".search-container");
            let resultsDiv = document.getElementById("searchResults");

            if (!resultsDiv) {
                resultsDiv = document.createElement("div");
                resultsDiv.id = "searchResults";
                resultsDiv.className = "search-results";
                searchContainer.appendChild(resultsDiv);
            }

            if (results.length === 0) {
                resultsDiv.innerHTML =
                    '<div class="search-result-item">No results found</div>';
                resultsDiv.style.display = "block";
                return;
            }

            resultsDiv.innerHTML = results
                .map((result) => {
                    let icon = "fas fa-folder";
                    let color = "#667eea";

                    switch (result.type) {
                        case "project":
                            icon = "fas fa-folder";
                            color = "#667eea";
                            break;
                        case "task":
                            icon = "fas fa-tasks";
                            color = "#28a745";
                            break;
                        case "milestone":
                            icon = "fas fa-flag";
                            color = "#17a2b8";
                            break;
                        case "document":
                            icon = "fas fa-file";
                            color = "#6c757d";
                            break;
                    }

                    let subtitle = "";
                    if (result.project_name) {
                        subtitle = `Project: ${result.project_name}`;
                    } else if (result.status) {
                        subtitle = `Status: ${result.status}`;
                    }

                    return `
                    <div class="search-result-item" onclick="navigateToResult('${result.type}', ${result.id}, '${result.tab || ""}')">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="${icon}" style="color: ${color}; width: 16px;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">${result.name}</div>
                                <div style="font-size: 12px; color: #718096;">
                                    ${result.type.charAt(0).toUpperCase() + result.type.slice(1)}
                                    ${subtitle ? "  " + subtitle : ""}
                                </div>
                                ${result.description ? `<div style="font-size: 12px; color: #718096; margin-top: 2px;">${result.description.substring(0, 100)}${result.description.length > 100 ? '...' : ''}</div>` : ""}
                            </div>
                        </div>
                    </div>
                `;
                })
                .join("");

            resultsDiv.style.display = "block";
        }

        function hideSearchResults() {
            const resultsDiv = document.getElementById("searchResults");
            if (resultsDiv) {
                resultsDiv.style.display = "none";
            }
        }

        function navigateToResult(type, id, tab) {
            hideSearchResults();
            document.getElementById("adminSearchInput").value = "";

            if (tab) {
                selectTab(tab, {
                    target: {
                        closest: () => ({ classList: { add: () => { } } }),
                    },
                });
            }

            setTimeout(() => {
                const element = document.querySelector(`[data-id="${id}"]`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    element.style.backgroundColor = '#f0f4ff';
                    setTimeout(() => {
                        element.style.backgroundColor = '';
                    }, 2000);
                }
            }, 300);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            const dragDropArea = document.getElementById('dragDropArea');
            dragDropArea.style.borderColor = '#667eea';
            dragDropArea.style.background = '#e6e9ff';
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            const dragDropArea = document.getElementById('dragDropArea');
            dragDropArea.style.borderColor = '#667eea';
            dragDropArea.style.background = '#f7fafc';
        }

        function handleDropZone(event) {
            event.preventDefault();
            event.stopPropagation();

            const dragDropArea = document.getElementById('dragDropArea');
            dragDropArea.style.borderColor = '#667eea';
            dragDropArea.style.background = '#f7fafc';

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleAvatarSelect({ target: { files: files } });
            }
        }

        function closeAvatarModal() {
            document.getElementById('avatarUploadModal').classList.remove('active');
        }

        function uploadAvatarFile() {
            triggerAvatarInput();
            closeAvatarModal();
        }

        function renderRealTimeProjects(projects) {
            const container = document.getElementById('realTimeProjects');
            if (!container) return;

            if (!projects || projects.length === 0) {
                const noActive = document.getElementById('noActiveProjects');
                if (noActive) noActive.style.display = 'block';
                container.innerHTML = '';
                return;
            }

            const noActive = document.getElementById('noActiveProjects');
            if (noActive) noActive.style.display = 'none';

            container.innerHTML = projects.map(project => `
                <div class="item-card" data-project-id="${project.id}">
                    <div class="item-content">
                        <h5><i class="fas fa-project-diagram"></i> ${project.title}</h5>
                        <p>${project.description || 'No description'}</p>
                        
                        <div class="row" style="margin-top: 15px;">
                            <div class="col-md-4">
                                <div class="real-time-stat">
                                    <h6><i class="fas fa-calendar-plus"></i> Created</h6>
                                    <div class="time-display" id="created-${project.id}">
                                        ${formatDate(project.created_at)}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="real-time-stat">
                                    <h6><i class="fas fa-clock"></i> Daily Report</h6>
                                    <div class="time-display" id="reporting-${project.id}">
                                        ${project.reporting_time || '09:00'}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="real-time-stat">
                                    <h6><i class="fas fa-calendar-times"></i> Deadline</h6>
                                    <div class="time-display countdown" id="deadline-${project.id}" 
                                         data-deadline="${project.deadline}">
                                        ${formatDate(project.deadline)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Overall Progress -->
                        <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="font-size: 14px; color: #2d3748;">Overall Progress</strong>
                                <span style="font-weight: 700; color: #667eea; font-size: 16px;">
                                    <span id="progress-text-${project.id}">${project.progress || 0}</span>%
                                </span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div id="progress-bar-${project.id}" class="progress-bar" role="progressbar" 
                                     aria-valuemin="0" aria-valuemax="100" aria-valuenow="${project.progress || 0}"
                                     style="width: ${project.progress || 0}%; background:  linear-gradient(90deg, #667eea, #764ba2);">
                                </div>
                            </div>
                        </div>

                        <!-- Task & Milestone Breakdown -->
                        <div style="margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap:  10px;">
                            <div style="background: #e8f4fd; padding: 10px; border-radius: 6px; text-align: center;">
                                <small style="color: #0c5aa0; font-weight: 600;">Tasks</small>
                                <div style="color: #0c5aa0; font-weight: 700; font-size: 14px;">
                                    <span id="tasks-completed-${project.id}">${project.completed_tasks || 0}</span>/<span id="tasks-total-${project.id}">${project.total_tasks || 0}</span>
                                </div>
                            </div>
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; text-align: center;">
                                <small style="color: #1b5e20; font-weight:  600;">Milestones</small>
                                <div style="color: #1b5e20; font-weight: 700; font-size: 14px;">
                                    <span id="milestones-completed-${project.id}">${project.completed_milestones || 0}</span>/<span id="milestones-total-${project.id}">${project.total_milestones || 0}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="item-meta" style="margin-top: 12px;">
                            <span><i class="fas fa-user"></i> ${project.creator_name || 'Unknown'}</span>
                            <span><i class="fas fa-history"></i> Updated: ${formatTimeAgo(project.updated_at)}</span>
                            <span class="badge ${getStatusBadgeClass(project.status)}">${project.status}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateProgressElements(projects) {
            if (!projects || projects.length === 0) return;
            
            projects.forEach(p => {
                try {
                    const bar = document.getElementById(`progress-bar-${p.id}`);
                    const text = document.getElementById(`progress-text-${p.id}`);
                    const tasksCompleted = document.getElementById(`tasks-completed-${p.id}`);
                    const tasksTotal = document.getElementById(`tasks-total-${p.id}`);
                    const milestonesCompleted = document.getElementById(`milestones-completed-${p.id}`);
                    const milestonesTotal = document.getElementById(`milestones-total-${p.id}`);
                    
                    if (bar) {
                        bar.style.transition = 'width 0.6s ease';
                        bar.style.width = (p.progress || 0) + '%';
                        bar.setAttribute('aria-valuenow', p.progress || 0);
                    }
                    if (text) {
                        text.textContent = p.progress || 0;
                    }
                    if (tasksCompleted) {
                        tasksCompleted.textContent = p.completed_tasks || 0;
                    }
                    if (tasksTotal) {
                        tasksTotal.textContent = p.total_tasks || 0;
                    }
                    if (milestonesCompleted) {
                        milestonesCompleted.textContent = p.completed_milestones || 0;
                    }
                    if (milestonesTotal) {
                        milestonesTotal.textContent = p.total_milestones || 0;
                    }
                } catch (error) {
                    console.error('[v0] Error updating progress for project ' + p.id + ':', error);
                }
            });
        }

        function updateProjectTimers() {
            const countdownElements = document.querySelectorAll('.countdown');
            countdownElements.forEach(element => {
                if (!element) return;
                const deadline = element.getAttribute('data-deadline');
                if (deadline) {
                    const timeLeft = calculateTimeLeft(deadline);
                    element.innerHTML = timeLeft;
                    if (element.style) {
                        element.style.color = timeLeft.includes('Overdue') ? '#f56565' : '#48bb78';
                    }
                }
            });

            const now = new Date();
            const currentTime = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();

            const timeDisplays = document.querySelectorAll('.time-display:not(.countdown)');
            timeDisplays.forEach(element => {
                if (!element || !element.style) return;
                if (element.textContent.includes(':')) {
                    const [hours, minutes] = element.textContent.split(':').map(Number);
                    const reportingTime = new Date();
                    reportingTime.setHours(hours, minutes, 0, 0);

                    if (now > reportingTime) {
                        element.style.color = '#f56565';
                    } else if ((reportingTime - now) < 3600000) {
                        element.style.color = '#ed8936';
                    } else {
                        element.style.color = '#48bb78';
                    }
                }
            });
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatTimeAgo(dateString) {
            if (!dateString) return 'Just now';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        function calculateTimeLeft(deadline) {
            if (!deadline) return 'No deadline';

            const deadlineDate = new Date(deadline);
            const now = new Date();
            const diffMs = deadlineDate - now;

            if (diffMs < 0) return 'Overdue!';

            const diffDays = Math.floor(diffMs / 86400000);
            const diffHours = Math.floor((diffMs % 86400000) / 3600000);

            if (diffDays > 0) return `${diffDays}d ${diffHours}h left`;
            if (diffHours > 0) return `${diffHours}h left`;
            return 'Due today!';
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'Completed': return 'badge-success';
                case 'In Progress': return 'badge-info';
                case 'On Hold': return 'badge-warning';
                case 'Cancelled': return 'badge-danger';
                default: return 'badge-secondary';
            }
        }

        async function completeProject(projectId) {
            if (!confirm("Mark this project as completed?")) return;
            try {
                const response = await fetch(
                    `${API_BASE}/employee/projects/${projectId}/complete`,
                    {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${localStorage.getItem("employee_token")}`,
                        },
                    },
                );
                if (response.ok) {
                    showAlert("Project completed!", "success");
                    loadDashboardData();
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || "Failed to complete project", "error");
                }
            } catch (error) {
                console.error("[v0] Project completion error:", error);
                showAlert("Error completing project", "error");
            }
        }

        // Clean up interval on page unload
        window.addEventListener('beforeunload', () => {
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
            }
        });
    </script>
</body>

</html>